<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Deleted PAC Records ‚Äî PAC Management System</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>


<!-- ‚≠ê Favicon -->
<link rel="icon" type="image/png" href="assets/fav.png">
<link rel="apple-touch-icon" href="assets/fav.png">
<style>
/* ---------------- GLOBAL ---------------- */
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:'Poppins',sans-serif;
  background:linear-gradient(135deg,#6e00ff,#0057ff,#00e5ff);
  background-size:300% 300%;
  animation: aurora 25s ease infinite;
  color:#333;
  overflow-x:hidden;
}

@keyframes aurora {
  0%{background-position:0% 50%;}
  50%{background-position:100% 50%;}
  100%{background-position:0% 50%;}
}

/* SOFT GLOW CONTAINER */
.glass-box{
  backdrop-filter:blur(12px);
  background:rgba(255,255,255,0.20);
  border-radius:18px;
  box-shadow:0 10px 30px rgba(0,0,0,0.25);
  border:1px solid rgba(255,255,255,0.35);
}

/* ---------------- HEADER ---------------- */
header{
  background:rgba(0,0,0,0.45);
  backdrop-filter:blur(8px);
  color:#fff;
  padding:18px 40px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:sticky;
  top:0;z-index:1000;
  box-shadow:0 4px 25px rgba(0,0,0,0.45);
  border-bottom:1px solid rgba(255,255,255,0.3);
}

header h1{
  font-size:26px;
  display:flex;
  align-items:center;
  gap:10px;
}

nav a{
  color:white;
  margin-left:25px;
  font-weight:600;
  text-decoration:none;
  position:relative;
  transition:0.3s;
}

nav a:hover{
  color:#ffeb3b;
}

nav a::after{
  content:"";
  position:absolute;
  left:0;bottom:-4px;
  width:0;height:2px;
  background:#ffeb3b;
  transition:0.3s;
}

nav a:hover::after{
  width:100%;
}

.menu-toggle{
  display:none !important;
}

/* ---------------- MOBILE MENU ---------------- */
@media(max-width:768px){
  header{padding:12px 18px;}
  header h1{font-size:18px;gap:8px;}

  .menu-toggle{
    display:block !important;
    font-size:24px;
    cursor:pointer;
    color:#fff;
  }

  header nav{
    position:absolute;
    top:60px;left:0;
    width:100%;
    background:rgba(0,0,0,0.65);
    max-height:0;
    overflow:hidden;
    flex-direction:column;
    transition:max-height 0.35s ease;
    border-bottom-left-radius:20px;
    border-bottom-right-radius:20px;
  }

  header nav.show{
    max-height:450px;
  }

  header nav a{
    padding:14px 22px;
    margin:0;
    display:block;
    font-size:15px;
  }
}

/* ---------------- PAGE TITLE ---------------- */
.page-title{
  text-align:center;
  margin-top:40px;
  font-size:30px;
  color:white;
  font-weight:700;
  text-shadow:0 2px 10px rgba(0,0,0,0.4);
}

/* ---------------- STATS ---------------- */
.stats-bar{
  display:flex;
  justify-content:center;
  gap:20px;
  margin:20px auto;
  width:95%;
  flex-wrap:wrap;
}

.stat-card{
  background:rgba(255,255,255,0.15);
  padding:18px 25px;
  border-radius:14px;
  color:white;
  text-align:center;
  min-width:200px;
  box-shadow:0 5px 25px rgba(0,0,0,0.3);
  backdrop-filter:blur(10px);
  border:1px solid rgba(255,255,255,0.25);
}

.stat-card h3{
  font-size:26px;
}

/* ---------------- SEARCH ---------------- */
.search-bar{
  width:95%;
  max-width:650px;
  margin:25px auto;
}

.search-bar input{
  width:100%;
  padding:14px 18px;
  border-radius:10px;
  border:2px solid rgba(255,255,255,0.6);
  font-size:15px;
  outline:none;
  background:rgba(255,255,255,0.3);
  color:white;
}

.search-bar input::placeholder{
  color:white;
}

/* ---------------- FILTER ---------------- */
.filters{
  display:flex;
  gap:20px;
  margin:10px auto 20px;
  width:95%;
  flex-wrap:wrap;
  justify-content:center;
}

.filters select, .filters input{
  padding:10px 12px;
  border-radius:8px;
  background:rgba(255,255,255,0.3);
  border:2px solid rgba(255,255,255,0.5);
  color:white;
}

.filters option{
  color:black;
}

/* ---------------- TABLE ---------------- */
.table-container{
  width:95%;
  max-width:1400px;
  margin:auto;
  background:rgba(255,255,255,0.25);
  border-radius:18px;
  backdrop-filter:blur(10px);
  padding:20px;
  box-shadow:0 8px 35px rgba(0,0,0,0.25);
}

table{
  width:100%;
  border-collapse:collapse;
}

th{
  background:rgba(0,0,0,0.65);
  color:white;
  padding:12px;
  font-size:14px;
}

td{
  padding:10px;
  font-size:13px;
  color:white;
  border-bottom:1px solid rgba(255,255,255,0.2);
}

tr{
  transition:0.3s;
}

tr:hover{
  background:rgba(255,255,255,0.15);
}

/* ---------------- BUTTONS ---------------- */
.action-btn{
  padding:7px 12px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  color:white;
  font-size:14px;
}

.restore-btn{background:#28a745;}
.restore-btn:hover{background:#1f8b36;}

.del-btn{background:#d93025;}
.del-btn:hover{background:#b72319;}

/* ---------------- MOBILE CARD ---------------- */
.mobile-card{
  display:none;
  width:94%;
  margin:15px auto;
  padding:18px;
  border-radius:16px;
  background:rgba(255,255,255,0.22);
  backdrop-filter:blur(10px);
  border-left:4px solid #00e5ff;
  color:white;
  box-shadow:0 8px 20px rgba(0,0,0,0.35);
}

.mobile-card p{margin:4px 0;font-size:14px;}

@media(max-width:768px){
  table{display:none;}
  .mobile-card{display:block;}
}

/* ---------------- FOOTER ---------------- */
footer{
  margin-top:60px;
  text-align:center;
  padding:25px;
  color:white;
  background:rgba(0,0,0,0.45);
  backdrop-filter:blur(10px);
  border-top:1px solid rgba(255,255,255,0.25);
}


.modal-box {
  background: rgba(255,255,255,0.15);
  padding: 25px;
  width: 90%;
  max-width: 450px;
  border-radius: 15px;
  color: white;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  backdrop-filter: blur(12px);
  border: 1px solid rgba(255,255,255,0.3);
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from {opacity:0; transform: scale(0.92);}
  to {opacity:1; transform: scale(1);}
}

.modal-box h2 {
  font-size: 20px;
  margin-bottom: 10px;
  text-align: center;
} 

#modalContent p {
  margin: 6px 0;
  font-size: 15px;
}

.close-btn {
  margin-top: 12px;
  display: block;
  width: 100%;
  padding: 10px;
  background: #d93025;
  border: none;
  color: white;
  border-radius: 8px;
  font-size: 16px;
  cursor: pointer;
}
.close-btn:hover {
  background: #b72319;
}

/* view button style */
.view-btn {
  background: #cfe23a;
}
.view-btn:hover {
  background: #ebc033;
}

/* PAGINATION BUTTONS */
.page-btn {
  padding: 8px 16px;
  margin: 0 6px;
  border: 1px solid rgba(255,255,255,0.35);
  border-radius: 10px;
  cursor: pointer;
  background: rgba(255,255,255,0.18);
  color: white;
  backdrop-filter: blur(10px);
  font-size: 15px;
  font-weight: 600;
  transition: 0.3s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
}

/* HOVER EFFECT */
.page-btn:hover {
  background: rgba(255,255,255,0.35);
  transform: translateY(-2px);
  box-shadow: 0 6px 18px rgba(0,0,0,0.35);
}

/* ACTIVE PAGE BUTTON */
.page-btn.active {
  background: #00e5ff;
  color: #000;
  border-color: #00e5ff;
  box-shadow: 0 0 12px #00e5ff;
}

/* DISABLED BUTTON */
.page-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
  transform: none;
}

/* PAGE SELECT DROPDOWN */
.page-select {
  padding: 8px 14px;
  border-radius: 10px;
  margin-left: 15px;
  background: rgba(255,255,255,0.25);
  border: 1px solid rgba(255,255,255,0.35);
  color: white;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  backdrop-filter: blur(10px);
  transition: 0.3s;
  appearance: none;
  -webkit-appearance: none;
  position: relative;
}

/* CUSTOM ARROW */
.page-select::after {
  content: "‚ñº";
  font-size: 12px;
  color: white;
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
}

/* DROPDOWN OPTIONS */
.page-select option {
  background: #007bff;
  color: white;
  padding: 10px;
}

/* ============================
      MOBILE PAGINATION FIX
   ============================ */
@media (max-width: 768px) {

  /* Pagination wrapper spacing */
  #pagination {
    display: flex;
    flex-direction: column;
    gap: 12px;
    align-items: center;
    justify-content: center;
  }

  /* Page numbers container */
  #pageNumbers {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
  }

  /* Buttons resize for mobile */
  .page-btn {
    min-width: 55px;
    padding: 8px 12px;
    font-size: 14px;
  }

  /* Move dropdown below buttons */
  .page-select {
    width: 90px;
    text-align: center;
    margin-left: 0;
  }
}

/* SELECT WRAPPER FOR CUSTOM ARROW */
/* WRAPPER FOR CUSTOM DROPDOWN */
.select-wrapper {
  position: relative;
  display: inline-block;
}

/* FIX SELECT PADDING SO ARROW HAS SPACE */
.page-select {
  padding-right: 35px !important; /* More space for arrow */
}

/* CUSTOM ARROW */
.select-wrapper::after {
  content: "‚ñº";
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: white;
  pointer-events: none;
  font-size: 13px;
  opacity: 0.9;
}

/* ===================== DELETED PAC EXPORT MODAL STYLES ===================== */

/* ======= GLASS EXPORT MODAL (ACCOUNT THEME) ======= */

#deletedExportModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  backdrop-filter: blur(6px);
  justify-content: center;
  align-items: center;
  z-index: 99999;
}

#deletedExportModal .modal-content {
  width: 850px;
  max-width: 95%;
  padding: 35px;
  border-radius: 22px;
  background: rgba(255,255,255,0.15);
  border: 1px solid rgba(255,255,255,0.35);
  backdrop-filter: blur(15px);
  box-shadow: 0 12px 40px rgba(0,0,0,0.35);
  animation: fadePopAccount 0.28s ease-out;
  text-align: center;
}

@keyframes fadePopAccount {
  from { opacity: 0; transform: scale(0.92); }
  to   { opacity: 1; transform: scale(1); }
}

#deletedExportModal h3 {
  font-size: 24px;
  font-weight: 700;
  color: white;
  text-shadow: 0 0 12px rgba(255,255,255,0.35);
}

#deletedExportModal .sub-text {
  color: #e8e8e8;
  font-size: 14px;
  margin-top: 2px;
  opacity: 0.85;
}

/* ===== Range Buttons ===== */
.range-group {
  display: flex;
  gap: 16px;
  margin: 25px auto;
  justify-content: center;
  flex-wrap: wrap;
}

.range-btn {
  flex: 1;
  min-width: 150px;
  padding: 14px;
  background: rgba(255,255,255,0.18);
  color: white;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.35);
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: 0.25s ease;
  backdrop-filter: blur(10px);
}

.range-btn:hover {
  background: rgba(255,255,255,0.28);
  transform: translateY(-2px);
  box-shadow: 0 0 15px rgba(0,200,255,0.35);
}

/* ACTIVE state */
.active-btn {
  background: linear-gradient(135deg, #00eaff, #007bff) !important;
  border-color: transparent !important;
  box-shadow: 0 0 18px rgba(0,200,255,0.65);
  transform: scale(1.05);
}


/* ===== Input Fields ===== */

.range-input {
  width: 95%;
  padding: 14px 16px;
  background: rgba(255,255,255,0.25);
  border: 1px solid rgba(255,255,255,0.4);
  border-radius: 14px;
  font-size: 15px;
  color: white;
  display: none;
  margin: 10px auto;
  backdrop-filter: blur(10px);
}

.range-input::placeholder {
  color: #eee;
}

 /* ---------------------------
   EXPORT FORMAT BUTTONS ROW
---------------------------- */

.export-group {
  display: flex;
  gap: 18px;
  justify-content: center;
  flex-wrap: wrap;
  margin: 22px auto;
}

.export-option {
  flex: 1;
  min-width: 140px;
  padding: 14px 0;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,0.35);
  background: rgba(255,255,255,0.15);
  color: white;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  backdrop-filter: blur(12px);
  box-shadow: 0 6px 22px rgba(0,0,0,0.30);
  transition: 0.25s ease;
}

/* INDIVIDUAL BUTTON COLOR HINTS */
.export-option:nth-child(1) { border-left: 4px solid #00a2ff; } /* CSV */
.export-option:nth-child(2) { border-left: 4px solid #2ecc71; } /* Excel */
.export-option:nth-child(3) { border-left: 4px solid #007bff; } /* PDF */

/* Hover */
.export-option:hover {
  transform: translateY(-3px);
  background: rgba(255,255,255,0.25);
  box-shadow: 0 8px 26px rgba(0,0,0,0.40);
}

/* Active */
.export-option:active {
  transform: scale(0.96);
}


/* -----------------------------
   EXPORT NOW / CLOSE BUTTONS
------------------------------ */

.export-footer {
  display: flex;
  gap: 20px;
  margin-top: 25px;
}

/* Make ALL footer buttons perfectly equal size */
.export-footer button {
  flex: 1 !important;
  width: 100% !important;
  padding: 16px 20px;       /* equal padding */
  border-radius: 18px;
  border: none;
  font-size: 17px;
  font-weight: 700;
  cursor: pointer;
  transition: 0.25s ease;
  letter-spacing: 0.4px;
  backdrop-filter: blur(10px);
  color: white;
  text-align: center;       /* ensures text stays centered */
}

/* Export Now ‚Äì Cyan Primary Button */
.export-now-btn {
  background: linear-gradient(135deg, #00dffb, #00a6d8);
  box-shadow: 0 8px 26px rgba(0, 215, 255, 0.45);
}

.export-now-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 32px rgba(0, 240, 255, 0.55);
}

/* Close Button ‚Äì Soft Danger Red */
.close-btn {
  background: linear-gradient(135deg, #ff5959, #d63030);
  box-shadow: 0 8px 26px rgba(255, 70, 70, 0.40);
}

.close-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 32px rgba(255, 70, 70, 0.55);
}


/* ======================================
        MOBILE HEIGHT FIX (COMPACT UI)
   ====================================== */
@media (max-width: 600px) {

  /* Reduce modal padding & radius */
  #deletedExportModal .modal-content {
    padding: 18px 20px !important;
    border-radius: 14px !important;
  }

  /* Reduce header spacing */
  #deletedExportModal h3 {
    margin-bottom: 4px !important;
    font-size: 19px !important;
  }

  .sub-text {
    margin-bottom: 10px !important;
    font-size: 13px !important;
  }

  /* SECTION TITLE spacing */
  #deletedExportModal hr {
    margin: 10px 0 !important;
  }

  /* RANGE BUTTONS */
  .range-group {
    gap: 10px !important;
    margin: 10px 0 !important;
  }

  .range-btn {
    padding: 10px !important;
    border-radius: 12px !important;
    font-size: 14px !important;
  }

  /* EXPORT FORMAT BUTTONS */
  .export-group {
    gap: 10px !important;
    margin: 12px 0 !important;
  }

  .export-option {
    padding: 10px !important;
    border-radius: 12px !important;
    font-size: 14px !important;
  }

  /* Export Now / Close Buttons */
  .export-footer {
    gap: 12px !important;
    margin-top: 15px !important;
  }

  .export-footer button {
    padding: 12px 0 !important;
    font-size: 15px !important;
    border-radius: 14px !important;
  }

}

/* ==========================
   UCL DROPDOWN (Glass Style)
   ========================== */

#delUclList {
  width: 100%;
  padding: 12px 16px;
  margin: 8px 0 16px 0;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.35);
  background: rgba(255,255,255,0.15);
  color: white;
  font-size: 15px;
  font-weight: 500;
  backdrop-filter: blur(10px);
  cursor: pointer;
  transition: 0.25s ease;
}

/* Placeholder color */
#delUclList option {
  color: black;
}

/* Hover */
#delUclList:hover {
  background: rgba(255,255,255,0.25);
}

/* When dropdown opens */
#delUclList:focus {
  outline: none;
  border-color: #00c8ff;
  box-shadow: 0 0 12px rgba(0,200,255,0.45);
}


/* === FIX EXPORT BUTTON STYLING === */

/* ======================== 
      MAIN EXPORT BUTTON 
   (Account Glass Theme)
======================== */

.export-container {
  width: 100%;
  text-align: center;
  margin: 20px 0 35px;
}

.export-del-btn {
  background: rgba(255,255,255,0.18);
  padding: 15px 34px;
  border: 1px solid rgba(255,255,255,0.35);
  border-radius: 18px;
  font-size: 17px;
  font-weight: 600;
  color: white;
  cursor: pointer;
  backdrop-filter: blur(12px);
  display: inline-flex;
  align-items: center;
  gap: 12px;
  transition: 0.28s ease;
  box-shadow: 
      0 8px 22px rgba(0,0,0,0.25),
      0 0 15px rgba(0,200,255,0.35);
}

/* Icon inside button */
.export-del-btn i {
  font-size: 20px;
  color: #00eaff;
}

/* Hover effect */
.export-del-btn:hover {
  background: rgba(255,255,255,0.28);
  transform: translateY(-2px);
  box-shadow: 
      0 10px 28px rgba(0,0,0,0.35),
      0 0 18px rgba(0,255,255,0.55);
  border-color: rgba(0,255,255,0.65);
}

/* Active click effect */
.export-del-btn:active {
  transform: scale(0.96);
  box-shadow: 0 5px 14px rgba(0,0,0,0.35);
}

/* ============ UNIVERSAL MODAL BG ============ */
.modal-bg {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  backdrop-filter: blur(8px);
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

/* ============ UNIVERSAL MODAL BOX STYLE ============ */
.modal-box {
  background: rgba(255,255,255,0.15);
  padding: 25px;
  border-radius: 15px;
  color: white;
  border: 1px solid rgba(255,255,255,0.3);
  box-shadow: 0 10px 30px rgba(0,0,0,0.35);
  backdrop-filter: blur(12px);
  animation: fadeIn 0.3s ease;
}


/* ============ DELETE DETAIL MODAL (FULL RECORDS) ============ */
.delete-modal-box {
  max-width: 1500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  overflow-x: auto;
}

/* FULL DETAIL TABLE ‚Üí Show EVERYTHING (NO CUTTING) */
.delete-popup-table table {
  width: 100%;
  border-collapse: collapse;
  table-layout: auto; /* expand naturally */
}

.delete-popup-table th,
.delete-popup-table td {
  padding: 10px;
  font-size: 14px;
  white-space: normal;      /* allow wrapping */
  overflow: visible !important;
  text-overflow: unset !important;
  word-break: break-word;   /* break long CSC, PAC, IP, Deleted Date */
}

/* ============ VIEW POPUP (SMALL DETAILS) ============ */
.view-modal-box {
  width: 95%;
  max-width: 500px;
}


/* ==========================================================
   üîµ UPDATE SINGLE BUTTON
   ========================================================== */
.update-single-btn {
  background: #00c853;        /* Green */
  color: white;
  padding: 6px 14px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(0, 200, 83, 0.4);
  transition: 0.2s ease-in-out;
}

.update-single-btn:hover {
  background: #00e676;
  box-shadow: 0 4px 16px rgba(0, 230, 118, 0.55);
  transform: translateY(-2px);
}

.update-single-btn:active {
  transform: scale(0.95);
}


/* ==========================================================
   üü¢ UPDATE ALL BUTTON
   ========================================================== */
.update-all-btn {
  background: #2979ff;        /* Blue */
  color: white;
  padding: 6px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  margin-left: 10px;
  box-shadow: 0 4px 12px rgba(41, 121, 255, 0.4);
  transition: 0.2s ease-in-out;
}

.update-all-btn:hover {
  background: #448aff;
  box-shadow: 0 4px 16px rgba(68, 138, 255, 0.55);
  transform: translateY(-2px);
}

.update-all-btn:active {
  transform: scale(0.95);
}

/* ==========================================================
   üì± MOBILE OPTIMIZATION FOR ALL POPUPS
   Applies to: modal-box, delete-modal-box, view-modal-box,
   single update button, update-all button
========================================================== */
@media (max-width: 600px) {

  /* Universal Modal Background */
  .modal-bg {
    padding: 10px; /* prevent edges cutting */
    align-items: flex-start; /* allow top scroll */
  }

  /* Universal Modal Box */
  .modal-box {
    width: 100%;
    max-width: 100%;
    padding: 15px !important;
    border-radius: 12px !important;
    margin-top: 25px; /* better spacing on small screens */
    max-height: 85vh !important;
    overflow-y: auto !important;
  }

  /* Large DELETE DETAILS Modal */
  .delete-modal-box {
    width: 100% !important;
    max-width: 100% !important;
    padding: 10px !important;
    border-radius: 10px !important;
    max-height: 85vh !important;
  }

  /* Table inside delete modal */
  .delete-popup-table table {
    font-size: 12px !important;
  }

  .delete-popup-table th,
  .delete-popup-table td {
    padding: 6px !important;
    font-size: 12px !important;
    line-height: 1.3;
  }

  /* View Popup (small details) */
  .view-modal-box {
    width: 100% !important;
    max-width: 100% !important;
    padding: 15px !important;
  }

  /* Update Single Button */
  .update-single-btn {
    padding: 6px 10px !important;
    font-size: 13px !important;
    border-radius: 5px !important;
  }

  /* Update All Button */
  .update-all-btn {
    padding: 6px 12px !important;
    font-size: 13px !important;
    margin-left: 5px !important;
    border-radius: 5px !important;
  }

  /* Input fields inside table */
  .delete-popup-table input {
    width: 100px !important;
    padding: 4px !important;
    font-size: 12px !important;
  }

  /* Headings inside popup */
  #deleteIdTable h2,
  #deleteIdTable h3 {
    font-size: 16px !important;
    text-align: center !important;
    margin: 10px 0 !important;
  }

  /* Close button */
  .close-btn {
    padding: 10px !important;
    font-size: 14px !important;
    border-radius: 10px !important;
  }
}

</style>
</head>
<body>

<!-- HEADER -->
<header>
  <h1><i class="fa-solid fa-database"></i> PAC Management</h1>
  <div class="menu-toggle" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></div>
  <nav id="mainMenu"></nav>
</header>

<h2 class="page-title">Deleted PAC Records</h2>

<!-- STAT CARDS -->
<div class="stats-bar">
  <div class="stat-card"><h3 id="totalCount">0</h3> Total Deleted</div>
  <div class="stat-card"><h3 id="todayCount">0</h3>Today Deleted</div>
  <div class="stat-card"><h3 id="todayAmount">‚Çπ0</h3>Total Deleted Amount</div>
  <div class="stat-card"><h3 id="dbSize">0 KB</h3>DB Size</div>
  <div class="stat-card"><h3 id="livePacCount">0</h3>Live PAC Count</div>
<div class="stat-card" onclick="openDuplicateDeleteTable()" style="cursor:pointer;"><h3 id="sameDeleteIdCount">0</h3>Same Delete ID Count <i class="fa-solid fa-eye"></i></div>

</div>

<!-- SEARCH -->
<div class="search-bar"><input id="searchInput" placeholder="Search PAC, UCL No, Owner Name..."></div>

<!-- FILTERS -->
<div class="filters">
  <input type="date" id="fromDate">
  <input type="date" id="toDate">
  <select id="uclFilter">
  <option value="">Filter by UCL ID</option>
</select>
</div>
<!-- Export Funcation -->
<div class="export-container">
  <button class="export-del-btn" onclick="openDeletedExportMenu()">
    <i class="fa-solid fa-file-export"></i> Export Deleted PAC Data
  </button>
</div>

<!-- Deleted PAC Export Modal -->
<div id="deletedExportModal" class="modal">
  <div class="modal-content">

    <h3>Export Deleted PAC Data</h3>
    <p class="sub-text">Choose Data Range & Export Type</p>

    <div class="range-group">
      <button class="range-btn" onclick="setDelRange('all', this)">All Deleted</button>
      <button class="range-btn" onclick="setDelRange('ucl', this)">By UCL</button>
      <button class="range-btn" onclick="setDelRange('date', this)">By Delete Date</button>
    </div>

    <select id="delUclList" class="range-input" style="display:none;"></select>
    <input type="date" id="delDateInput" class="range-input" style="display:none;">

    <hr>

    <h3>Select Export Format</h3>
    <div class="export-group">
      <button class="export-option" onclick="setDelExportType('csv', this)">CSV</button>
      <button class="export-option" onclick="setDelExportType('excel', this)">Excel</button>
      <button class="export-option" onclick="setDelExportType('pdf', this)">PDF</button>
    </div>

    <div class="export-footer">
      <button class="export-now-btn" onclick="startDeletedExport()">Export Now</button>
      <button class="close-btn" onclick="closeDeletedExportMenu()">Close</button>
    </div>

  </div>
</div>

<!-- Desktop TABLE View -->
<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>UCL No</th>
        <th>CSC Ref</th>
        <th>PAC No</th>
        <th>Amount</th>
        <th>Date</th>
        <th>Time</th>
        <th>Deleted</th>
        <th>Owner</th>
        <th>Deleted IP</th>
        <th>Deleted ID</th>
        <th>View</th>
        <th>Restore</th>
        <th>Delete</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<!-- MOBILE TABLE VIEW-->
<div id="mobileCards"></div>

<!-- PAGINATION -->
<div id="pagination" style="text-align:center; margin:25px 0; color:white;">
  <button id="prevPage" class="page-btn">Prev</button>
  <span id="pageNumbers"></span>
  <button id="nextPage" class="page-btn">Next</button>
<div class="select-wrapper">
  <select id="rowsPerPage" class="page-select">
    <option value="10">10</option>
    <option value="20">20</option>
    <option value="50">50</option>
  </select>
  </div>
</div>

<!-- DUPLICATE DELETE ID POPUP -->
<div id="deleteIdPopup" class="modal-bg">
  <div class="modal-box delete-modal-box">
      <div id="deleteIdTable"></div>
      <button class="close-btn" onclick="closeDeleteIdPopup()">Close</button>
  </div>
</div>

<!-- VIEW MODAL -->
<div id="viewModal" class="modal-bg">
  <div class="modal-box view-modal-box">
      <h2>View PAC Record</h2>
      <div id="modalContent"></div>
      <button class="close-btn" onclick="closeModal()">Close</button>
  </div>
</div>


<script>
  function closeDeleteIdPopup() {
    document.getElementById("deleteIdPopup").style.display = "none";
  }
</script>

<!-- FOOTER -->
<footer>
  &copy; 2025 PAC Management System
  <br><span id="live-time"></span> |
  <span id="user-ip"></span>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getFirestore, collection, query, orderBy, onSnapshot, doc, deleteDoc, setDoc }
from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCE2_x5xvW3wCsOx6jo9-ZhNOhgWm86cPY",
  authDomain: "mrsamrat08.firebaseapp.com",
  projectId: "mrsamrat08",
  storageBucket: "mrsamrat08.appspot.com",
  messagingSenderId: "525481767881",
  appId: "1:525481767881:web:6fd53162b242709890ae18"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------------- Global ---------------- */
let delRange = null;
let delRangeBtn = null;
let delExportType = null;
let delExportTypeBtn = null;


/* ---------------- LOAD NAV ---------------- */
function loadNav() {
  const menu = document.getElementById("mainMenu");
  const q = query(collection(db, "pacnav"), orderBy("order"));

  onSnapshot(q, snap => {
    menu.innerHTML = "";
    snap.forEach(doc => {
      const v = doc.data();
      menu.innerHTML += `<a href="${v.url}"><i class="${v.icon}"></i> ${v.title}</a>`;
    });
  });
}
loadNav();

/* ---------------- LOAD DELETED PAC DATA ---------------- */
const tableBody = document.getElementById("tableBody");
const mobileCards = document.getElementById("mobileCards");

let allPAC = [];

let currentPage = 1;
let rowsPerPageValue = 10;

// For filtered results
function getFilteredData() {
  const search = document.getElementById("searchInput").value.toLowerCase();
  const from = document.getElementById("fromDate").value;
  const to = document.getElementById("toDate").value;
  const uclFilter = document.getElementById("uclFilter").value;

  return allPAC.filter(d => {
    let txt = JSON.stringify(d).toLowerCase();

    if (search && !txt.includes(search)) return false;
    if (uclFilter && String(d.uclNo).trim() !== String(uclFilter).trim()) return false;

    // Date filter
    let delDate = parseDate(formatDeleteDate(
      d.deletedAt || d.deletedAtTimestamp || d.deleteTime
    ));
    let fromDate = from ? new Date(from) : null;
    let toDate = to ? new Date(to) : null;

    if (fromDate && (!delDate || delDate < fromDate)) return false;
    if (toDate && (!delDate || delDate > toDate)) return false;

    return true;
  });
}


function renderPagination() {
  const filtered = getFilteredData();
  const totalPages = Math.ceil(filtered.length / rowsPerPageValue);

  const pageNumbers = document.getElementById("pageNumbers");
  pageNumbers.innerHTML = "";

  if (totalPages <= 1) return;

  function addBtn(p) {
    pageNumbers.innerHTML += `
      <button onclick="goToPage(${p})"
      class="page-btn ${p === currentPage ? "active" : ""}">
        ${p}
      </button>`;
  }

  // Always show first page
  addBtn(1);

  // Show "..." if needed
  if (currentPage > 4) {
    pageNumbers.innerHTML += `<span style="color:white; margin:0 6px;">...</span>`;
  }

  // Pages around the current page (2 before, 2 after)
  for (let p = currentPage - 2; p <= currentPage + 2; p++) {
    if (p > 1 && p < totalPages) {
      addBtn(p);
    }
  }

  // Show "..." before last page
  if (currentPage < totalPages - 3) {
    pageNumbers.innerHTML += `<span style="color:white; margin:0 6px;">...</span>`;
  }

  // Always show last page if not same as first
  if (totalPages > 1) addBtn(totalPages);
}



function loadPAC() {
  const q = query(collection(db, "delete_pac"), orderBy("pacNo", "desc"));

  onSnapshot(q, snapshot => {

    allPAC = [];                // reset PAC array
    deleteIdCountMap = {};      // reset Delete ID count map

    let todayISO = new Date().toISOString().slice(0, 10);

    // UNIVERSAL DATE PARSER
    function extractISO(d) {

      if (!d) return "";

      if (typeof d === "number") {
        return new Date(d).toISOString().slice(0, 10);
      }

      if (d.includes("T") && d.includes("Z")) {
        return new Date(d).toISOString().slice(0, 10);
      }

      if (d.includes("/")) {
        let datePart = d.split(",")[0];
        let [day, month, year] = datePart.split("/");
        return `${year}-${month.padStart(2,"0")}-${day.padStart(2,"0")}`;
      }

      if (d.includes("-")) {
        let datePart = d.split(" ")[0];
        let [dd, mm, yyyy] = datePart.split("-");
        return `${yyyy}-${mm.padStart(2,"0")}-${dd.padStart(2,"0")}`;
      }

      return "";
    }

    let todayCount = 0;
    let pacGroups = {};
    let dbBytes = 0;
    let uclSet = new Set();

    // üî• FIXED ‚Äî Count Delete IDs & collect PAC data INSIDE snapshot
    snapshot.forEach(doc => {
      const d = doc.data();

      allPAC.push(d);            // store PAC
      updateDeleteIdCounts(d);   // count deleteViewId

      if (d.uclNo) uclSet.add(d.uclNo);

      dbBytes += JSON.stringify(d).length;

      if (!pacGroups[d.pacNo]) {
        pacGroups[d.pacNo] = { count: 0, amount: Number(d.amount) };
      }
      pacGroups[d.pacNo].count++;

      const delISO = extractISO(
        d.deletedAt || d.deletedAtTimestamp || d.deleteTime
      );

      if (delISO === todayISO) {
        todayCount++;
      }
    });

    // ‚≠ê Update Delete ID Card
    updateSameDeleteIdCountDisplay();

    // ‚≠ê Continue with your existing amount, UCL dropdown & pagination
    // (Your original code below here stays the same ‚Üì)


    // ===== UPDATE UCL FILTER DROPDOWN =====
    const uclSelect = document.getElementById("uclFilter");
    if (uclSelect) {
      uclSelect.innerHTML = `<option value="">Filter by UCL ID</option>`;
      uclSet.forEach(u => {
        const cleanUCL = String(u).trim();
        uclSelect.innerHTML += `<option value="${cleanUCL}">${cleanUCL}</option>`;
      });
    }

    // ===== TOTAL AMOUNT =====
    let totalAmount = 0;
    Object.values(pacGroups).forEach(p => {
      totalAmount += p.count * p.amount;
    });

    function formatSize(bytes) {
      if (bytes < 1024) return bytes + " B";
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + " KB";
      return (bytes / (1024 * 1024)).toFixed(2) + " MB";
    }

    let dbSize = formatSize(dbBytes);

    // ===== UPDATE UI =====
    document.getElementById("totalCount").textContent = allPAC.length;
    document.getElementById("todayCount").textContent = todayCount;
    document.getElementById("todayAmount").textContent = "‚Çπ" + totalAmount;
    document.getElementById("dbSize").textContent = dbSize;

    // üî• PAGINATION NOW CONTROLS RENDERING
    renderPage();
  });
}

loadPAC();

window.renderPage = function () {
  const filtered = getFilteredData();

  const start = (currentPage - 1) * rowsPerPageValue;
  const end = start + rowsPerPageValue;

  const displayData = filtered.slice(start, end);

  // Clear displays
  tableBody.innerHTML = "";
  mobileCards.innerHTML = "";

  // Render table + mobile cards
  displayData.forEach(d => {
    addRow(d);
    addCard(d);
  });

  // Render page buttons
  renderPagination();
};

// ‚úÖ ADD THIS FIX
window.goToPage = function(p) {
  currentPage = p;
  renderPage();
};

// PREVIOUS PAGE BUTTON
document.getElementById("prevPage").onclick = function () {
  if (currentPage > 1) {
    currentPage--;
    renderPage();
  }
};

// NEXT PAGE BUTTON
document.getElementById("nextPage").onclick = function () {
  const filtered = getFilteredData();
  const totalPages = Math.ceil(filtered.length / rowsPerPageValue);

  if (currentPage < totalPages) {
    currentPage++;
    renderPage();
  }
};

// ROWS PER PAGE SELECT
document.getElementById("rowsPerPage").onchange = function () {
  rowsPerPageValue = Number(this.value);
  currentPage = 1;
  renderPage();
};


/* ---------------- ADD TABLE ROW ---------------- */
function addRow(d) {

  let deletedValue = formatDeleteDate(
    d.deletedAt || 
    d.deletedAtTimestamp || 
    d.deleteTime
  );

  // If amount > 75 ‚Üí highlight entire row
  let highlightRow = Number(d.amount) > 75 
    ? "style='background: rgba(255, 66, 66, 0.35); box-shadow: inset 0 0 10px rgba(255,0,0,0.4); border-left: 4px solid #ff2d2d;'" 
    : "";

  tableBody.innerHTML += `
<tr ${highlightRow}>
  <td>${d.uclNo}</td>
  <td>${d.cscRef}</td>
  <td>${d.pacNo}</td>
  <td>${d.amount}</td>
  <td>${d.entryDate}</td>
  <td>${d.entryTime}</td>
  <td>${deletedValue}</td>
  <td>${d.uclOwnerName}</td>
  <td>${d.deleteIP}</td>
  <td>${d.deleteViewId}</td>
  <td><button class="action-btn view-btn" onclick='viewPAC(${JSON.stringify(d)})'>üëÅ</button></td>
  <td><button class="action-btn restore-btn" onclick='restorePAC(${JSON.stringify(d)})'>‚Ü©</button></td>
  <td><button class="action-btn del-btn" onclick="deletePAC('${d.pacNo}')">‚úñ</button></td>
</tr>`;
}


/* ---------------- ADD MOBILE CARD ---------------- */ 
function addCard(d) {

  let deletedValue = formatDeleteDate(
    d.deletedAt || 
    d.deletedAtTimestamp || 
    d.deleteTime
  );

mobileCards.innerHTML += `
<div class="mobile-card">
  <p><b>UCL:</b> ${d.uclNo}</p>
  <p><b>PAC:</b> ${d.pacNo}</p>
  <p><b>Amount:</b> ${d.amount}</p>
  <p><b>Date:</b> ${d.entryDate}</p>
  <p><b>Time:</b> ${d.entryTime}</p>
  <p><b>Deleted:</b> ${deletedValue}</p>
  <p><b>Owner:</b> ${d.uclOwnerName}</p>
  <p><b>Deleted IP:</b> ${d.deleteIP}</p>
  <p><b>Deleted ID:</b> ${d.deleteViewId}</p>
  <button class="action-btn view-btn" onclick='viewPAC(${JSON.stringify(d)})'>View</button>
  <button class="action-btn restore-btn" onclick='restorePAC(${JSON.stringify(d)})'>Restore</button>
  <button class="action-btn del-btn" onclick="deletePAC('${d.pacNo}')">Delete</button>
</div>`;
}

/* ---------------- RESTORE ---------------- */
window.restorePAC = async function(data) {
  if (!confirm(`Restore PAC ${data.pacNo}?`)) return;

  // Remove delete-only fields
  delete data.deleteIP;
  delete data.deleteViewId;
  delete data.deletedAt;
  delete data.deletedAtTimestamp;
  delete data.deleteTime;

  // (Optional but recommended) ensure required fields exist
  if (!data.createdAt) {
    data.createdAt = new Date().toISOString();
  }

  await setDoc(doc(db, "pac_entries", data.pacNo), data);
  await deleteDoc(doc(db, "delete_pac", data.pacNo));

  alert("PAC Restored!");
};

/* ---------------- DELETE ---------------- */
window.deletePAC = async function(pacNo) {
  if (!confirm(`Permanently delete PAC ${pacNo}?`)) return;

  await deleteDoc(doc(db, "delete_pac", pacNo));

  alert("Permanently Deleted!");
};

/* ---------------- universal delete formatter ---------------- */
function formatDeleteDate(d) {

  if (!d) return "‚Äî";

  let date;

  // CASE 1: Epoch timestamp number
  if (typeof d === "number") {
    date = new Date(d);
  }

  // CASE 2: ISO string
  else if (d.includes("T") && d.includes("Z")) {
    date = new Date(d);
  }

  // CASE 3: "3/12/2025, 8:16:57 pm"
  else if (d.includes("/")) {
    date = new Date(d);
  }

  // CASE 4: "24-12-2025 10:52 AM"
  else if (d.includes("-")) {
    let [datePart, timePart] = d.split(" ");
    let [dd, mm, yyyy] = datePart.split("-");
    date = new Date(`${yyyy}-${mm}-${dd} ${timePart}`);
  }

  else {
    return d;
  }

  // FORMAT OUTPUT ‚Üí DD-MM-YYYY HH:mm:ss AM/PM
  let day = String(date.getDate()).padStart(2, "0");
  let month = String(date.getMonth() + 1).padStart(2, "0");
  let year = date.getFullYear();

  let hours = date.getHours();
  let minutes = String(date.getMinutes()).padStart(2, "0");
  let seconds = String(date.getSeconds()).padStart(2, "0");

  let ampm = hours >= 12 ? "PM" : "AM";
  hours = hours % 12;
  hours = hours ? hours : 12;
  hours = String(hours).padStart(2, "0");

  return `${day}-${month}-${year} ${hours}:${minutes}:${seconds} ${ampm}`;
}

/* ---------------- PARSE DATE FOR FILTERS ---------------- */
function parseDate(x) {
  if (!x) return null;

  if (!isNaN(Date.parse(x))) return new Date(x);

  if (x.includes("-")) {
    let [dd, mm, yy] = x.split("-").map(s => s.trim());
    return new Date(`${yy}-${mm}-${dd}`);
  }

  if (x.includes("/")) {
    let [dd, mm, yy] = x.split("/");
    return new Date(`${yy}-${mm}-${dd}`);
  }

  return null;
}


/* ---------------- FINAL SEARCH + FILTER FUNCTION ---------------- */
function runFilters() {
  const search = document.getElementById("searchInput").value.toLowerCase();
  const from = document.getElementById("fromDate").value;
  const to = document.getElementById("toDate").value;
  const uclFilter = document.getElementById("uclFilter").value;


  const isMobile = window.innerWidth <= 768;

  const fromDate = from ? new Date(from) : null;
  const toDate = to ? new Date(to) : null;

 /* ===== MOBILE: CARD FILTER ===== */
const cards = document.querySelectorAll(".mobile-card");

cards.forEach(card => {
  let txt = card.innerText.toLowerCase();
  let match = txt.match(/deleted:\s*(.*)/i);
  let delDate = match ? parseDate(match[1].trim()) : null;

  let show = true;

  if (search && !txt.includes(search)) show = false;
  if (uclFilter && !txt.includes(String(uclFilter).toLowerCase())) show = false;
  if (fromDate && (!delDate || delDate < fromDate)) show = false;
  if (toDate && (!delDate || delDate > toDate)) show = false;

  card.style.display = show ? "block" : "none";
});

currentPage = 1;
renderPage();


}

window.viewPAC = function(d) {

  const modal = document.getElementById("viewModal");
  const content = document.getElementById("modalContent");

  content.innerHTML = `
    <p><b>UCL No:</b> ${d.uclNo}</p>
    <p><b>CSC Ref:</b> ${d.cscRef}</p>
    <p><b>PAC No:</b> ${d.pacNo}</p>
    <p><b>Amount:</b> ${d.amount}</p>
    <p><b>Date:</b> ${d.entryDate}</p>
    <p><b>Time:</b> ${d.entryTime}</p>
    <p><b>Deleted:</b> ${formatDeleteDate(
      d.deletedAt || d.deletedAtTimestamp || d.deleteTime
    )}</p>
    <p><b>Owner:</b> ${d.uclOwnerName}</p>
    <p><b>Deleted IP:</b> ${d.deleteIP}</p>
    <p><b>Deleted ID:</b> ${d.deleteViewId}</p>
    <p><b>Purpose:</b> ${d.purpose}</p>
    <p><b>PAC Saved IP:</b> ${d.savedFromIp}</p>
    <p><b>UCL Owner IP:</b> ${d.uclOwnerIp}</p>
  `;

  modal.style.display = "flex";
};

window.closeModal = function() {
  document.getElementById("viewModal").style.display = "none";
};


/* ---------------- LIVE PAC COUNT (from pac_entries) ---------------- */
function livePacCounter() {
  const q = collection(db, "pac_entries");

  onSnapshot(q, snap => {
    const count = snap.size;
    const el = document.getElementById("livePacCount");

    // Update value
    el.textContent = count;

    // Small animation effect
    el.style.transform = "scale(1.2)";
    el.style.transition = "0.3s";
    setTimeout(() => {
      el.style.transform = "scale(1)";
    }, 300);
  });
}

livePacCounter();



/* ----------------Export Model Close Button---------------- */
window.openDeletedExportMenu = function() {
  document.getElementById("deletedExportModal").style.display = "flex";
  loadDeletedUCLList();
};

window.closeDeletedExportMenu = function() {
  document.getElementById("deletedExportModal").style.display = "none";
};


window.setDelRange = function(type, btn) {
  delRange = type;

  if (delRangeBtn) delRangeBtn.classList.remove("active-btn");
  btn.classList.add("active-btn");
  delRangeBtn = btn;

  document.getElementById("delUclList").style.display = "none";
  document.getElementById("delDateInput").style.display = "none";

  if (type === "ucl") document.getElementById("delUclList").style.display = "block";
  if (type === "date") document.getElementById("delDateInput").style.display = "block";
};

window.setDelExportType = function(type, btn) {
  delExportType = type;

  if (delExportTypeBtn) delExportTypeBtn.classList.remove("active-btn");
  btn.classList.add("active-btn");
  delExportTypeBtn = btn;
};
 /* ===== UCL Export DROPDOWN List UCL ID ===== */
async function loadDeletedUCLList() {
  const dropdown = document.getElementById("delUclList");
  dropdown.innerHTML = "<option value=''>Select UCL</option>";

  let uclSet = new Set();
  allPAC.forEach(e => {
    if (e.uclNo) uclSet.add(e.uclNo);
  });

  [...uclSet].sort().forEach(u => {
    dropdown.innerHTML += `<option value="${u}">${u}</option>`;
  });
}
 /* ===== UCL Export Date Range ===== */
window.startDeletedExport = function() {

  if (!delRange) return alert("Select data range!");
  if (!delExportType) return alert("Select export type!");

  let exportData = allPAC;

  if (delRange === "ucl") {
    const u = document.getElementById("delUclList").value;
    exportData = allPAC.filter(e => String(e.uclNo).trim() === String(u).trim());
  }

  if (delRange === "date") {
    const d = document.getElementById("delDateInput").value;
    exportData = allPAC.filter(e => 
      formatDeleteDate(e.deletedAt || e.deletedAtTimestamp || e.deleteTime)
        .startsWith(d.split("-").reverse().join("-"))
    );
  }

  if (!exportData.length) return alert("No data found!");

  if (delExportType === "csv") exportDeletedCSV(exportData);
  if (delExportType === "excel") exportDeletedExcel(exportData);
  if (delExportType === "pdf") exportDeletedPDF(exportData);

  closeDeletedExportMenu();
};

 /* ===== Export CSV File ===== */
function exportDeletedCSV(data) {
  let csv = "UCL,CSC Ref,PAC,Amount,DeletedAt,Owner,IP\n";

  data.forEach(e => {
    csv += [
      e.uclNo, e.cscRef, e.pacNo, e.amount,
      formatDeleteDate(e.deletedAt || e.deletedAtTimestamp || e.deleteTime),
      e.uclOwnerName, e.deleteIP
    ].join(",") + "\n";
  });

  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
  a.download = `Deleted_PAC_${getTimestamp()}.csv`;

  a.click();
}


 /* ===== PDF Export ===== */
/* ===== ADVANCED PDF EXPORT WITH COPYRIGHT FOOTER ===== */
function exportDeletedPDF(data) {

  if (!data.length) return showToast("No deleted records!", "#dc3545");

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("landscape");

  const now = new Date();
  const timestamp = now.toLocaleString("en-IN");

  /* ===== PREMIUM HEADER BOX ===== */
  doc.setDrawColor(0, 122, 255);
  doc.setLineWidth(0.8);
  doc.roundedRect(10, 8, 270, 18, 4, 4);

  doc.setFont("helvetica", "bold");
  doc.setFontSize(15);
  doc.setTextColor(0, 122, 255);
  doc.text("DELETED PAC DATA REPORT", 145, 20, { align: "center" });

  /* SUBTITLE */
  doc.setFontSize(10);
  doc.setTextColor(50);
  doc.text(`Exported On: ${timestamp}`, 12, 33);
  doc.text(`Total Records: ${data.length}`, 250, 33);

  /* TABLE */
  const table = data.map((e, i) => [
    i + 1,
    e.uclNo || "",
    e.cscRef || "",
    e.pacNo || "",
    e.amount || "",
    e.entryDate || "",
    e.entryTime || "",
    formatDeleteDate(e.deletedAt || e.deletedAtTimestamp || e.deleteTime),
    e.uclOwnerName || "",
    e.deleteIP || "",
    e.deleteViewId || ""
  ]);

  doc.autoTable({
    startY: 40,
    head: [[
      "#","UCL No","CSC Ref","PAC No","Amount",
      "Entry Date","Entry Time","Deleted Date",
      "Owner","Deleted IP","Delete ID"
    ]],
    body: table,
    theme: "grid",
    headStyles: { fillColor: [0, 122, 255], fontSize: 10 },
    bodyStyles: { fontSize: 9 },
    alternateRowStyles: { fillColor: [240, 248, 255] },

    didDrawPage: function (data) {
      const pageHeight = doc.internal.pageSize.height;

      /* PAGE NUMBER */
      const pageCount = doc.internal.getNumberOfPages();
      doc.setFontSize(10);
      doc.text(
        `Page ${doc.internal.getCurrentPageInfo().pageNumber} of ${pageCount}`,
        doc.internal.pageSize.width / 2,
        pageHeight - 12,
        { align: "center" }
      );

      /* COPYRIGHT */
      doc.setFontSize(9);
      doc.setTextColor(120);
      doc.text(
        "¬© 2025 PAC Management System ‚Äî All Rights Reserved",
        doc.internal.pageSize.width / 2,
        pageHeight - 5,
        { align: "center" }
      );
    }
  });

  doc.save(`Deleted_PAC_Report_${getTimestamp()}.pdf`);
  showToast("PDF Exported Successfully!", "#007bff");
}



function getTimestamp() {
  const now = new Date();

  const dd = String(now.getDate()).padStart(2, "0");
  const mm = String(now.getMonth() + 1).padStart(2, "0");
  const yyyy = now.getFullYear();

  const hh = String(now.getHours()).padStart(2, "0");
  const min = String(now.getMinutes()).padStart(2, "0");
  const ss = String(now.getSeconds()).padStart(2, "0");

  return `${dd}-${mm}-${yyyy} ${hh}-${min}-${ss}`;
}



function showToast(msg, color="#007bff") {
  const toast = document.getElementById("toast");
  if (!toast) return alert(msg); // fallback if toast missing

  toast.innerText = msg;
  toast.style.background = color;
  toast.style.visibility = "visible";

  setTimeout(() => {
    toast.style.visibility = "hidden";
  }, 2000);
}

function toISODate(del) {
  let dt = formatDeleteDate(del);
  let [dd, mm, yyyy] = dt.split(" ")[0].split("-");
  return `${yyyy}-${mm}-${dd}`;
}


// GLOBAL Delete ID Count Map
let deleteIdCountMap = {};

// Update the count map inside loadPAC()
function updateDeleteIdCounts(record) {
  if (!record.deleteViewId) return;
  let id = String(record.deleteViewId).trim();
  deleteIdCountMap[id] = (deleteIdCountMap[id] || 0) + 1;
}

function updateSameDeleteIdCountDisplay() {
  let duplicateCount = Object.values(deleteIdCountMap).filter(c => c > 1).length;
  document.getElementById("sameDeleteIdCount").textContent = duplicateCount;
}

updateSameDeleteIdCountDisplay();

/* ===============================================================
   üî• OPEN DUPLICATE DELETE ID POPUP (FINAL CLEAN VERSION)
================================================================ */
window.openDuplicateDeleteTable = function () {

  const duplicateIds = Object.keys(deleteIdCountMap)
    .filter(id => deleteIdCountMap[id] > 1);

  if (!duplicateIds.length) {
    alert("No duplicate Delete IDs found.");
    return;
  }

  let html = `
    <h2 style="text-align:center; margin-bottom:20px;">
      Duplicate Delete ID Records
    </h2>
  `;

  duplicateIds.forEach(delId => {

    const list = allPAC.filter(r => r.deleteViewId === delId);

    // Track IDs already assigned (unique for the popup)
    let usedIds = new Set(Object.keys(deleteIdCountMap));

    html += `
      <h3 style="margin:20px 0; text-align:center; color:#ffeb3b;">
        Duplicate Delete ID: <b>${delId}</b>

        <button 
          class="update-all-btn"
          onclick="updateAllDeleteId('${delId}')">
          Update All
        </button>
      </h3>

      <div class="delete-popup-table">
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="background:#000; color:white;">
              <th>UCL</th>
              <th>CSC</th>
              <th>PAC</th>
              <th>Amount</th>
              <th>Date</th>
              <th>Time</th>
              <th>Deleted</th>
              <th>IP</th>
              <th>New Delete ID</th>
              <th>Update</th>
            </tr>
          </thead>
          <tbody>
    `;

    let keepOriginal = true;

    list.forEach(e => {

      let newId;

      if (keepOriginal) {
        newId = e.deleteViewId; // keep first ID
        keepOriginal = false;
        usedIds.add(newId);
      } else {
        newId = generateNextId(usedIds);
        usedIds.add(newId);
      }

      html += `
        <tr>
          <td>${e.uclNo}</td>
          <td>${e.cscRef}</td>
          <td>${e.pacNo}</td>
          <td>${e.amount}</td>
          <td>${e.entryDate}</td>
          <td>${e.entryTime}</td>
          <td>${formatDeleteDate(e.deletedAt || e.deletedAtTimestamp || e.deleteTime)}</td>
          <td>${e.deleteIP}</td>

          <td>
            <input 
              id="newDelId_${e.pacNo}"
              type="text"
              value="${newId}"
              readonly
              style="
                padding:4px 6px;
                width:130px;
                border-radius:6px;
                border:none;
                background:#d4ffcf;
                font-weight:600;
              ">
          </td>

          <td>
            <button 
              class="update-single-btn"
              onclick="updateSingleDeleteId('${e.pacNo}')">
              Update
            </button>
          </td>

        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>

      <hr style="margin:25px 0; border-color:rgba(255,255,255,0.2);">
    `;
  });

  document.getElementById("deleteIdTable").innerHTML = html;
  document.getElementById("deleteIdPopup").style.display = "flex";
};



/* ===============================================================
   üî• SMART UNIQUE DELETE ID GENERATOR (NO DUPLICATES EVER)
================================================================ */
function generateNextId(usedSet) {

  let next = 1;

  while (true) {
    let id = `DEL-${String(next).padStart(5, "0")}`;

    if (!usedSet.has(id)) return id;

    next++;
  }
}



/* ===============================================================
   üî• UPDATE SINGLE RECORD DELETE ID
================================================================ */
window.updateSingleDeleteId = async function(pacNo) {

  const input = document.getElementById(`newDelId_${pacNo}`);
  let newId = input.value.trim();

  const rec = allPAC.find(r => r.pacNo === pacNo);
  if (!rec) return alert("Record not found!");

  input.style.background = "#fff2b3"; // yellow while saving

  await setDoc(doc(db, "delete_pac", pacNo), {
    ...rec,
    deleteViewId: newId
  });

  input.style.background = "#b3ffb3"; // green after save

  setTimeout(openDuplicateDeleteTable, 300);
};



/* ===============================================================
   üî• UPDATE ALL RECORDS INSIDE SAME DUPLICATE GROUP
================================================================ */
window.updateAllDeleteId = async function(oldId) {

  const rows = allPAC.filter(r => r.deleteViewId === oldId);
  let count = 0;

  for (let rec of rows) {

    const input = document.getElementById(`newDelId_${rec.pacNo}`);
    const newId = input.value.trim();

    input.style.background = "#fff2b3";

    await setDoc(doc(db, "delete_pac", rec.pacNo), {
      ...rec,
      deleteViewId: newId
    });

    input.style.background = "#b3ffb3";
    count++;
  }

  alert(`Updated ${count} records successfully!`);

  setTimeout(openDuplicateDeleteTable, 300);
};




/* ---------------- LISTENERS ---------------- */
document.getElementById("searchInput").addEventListener("keyup", runFilters);
document.getElementById("fromDate").addEventListener("change", runFilters);
document.getElementById("toDate").addEventListener("change", runFilters);
document.getElementById("uclFilter").addEventListener("change", runFilters);

</script>

<script>
/* ---------------- TIME ---------------- */
function updateTime() {
  const el = document.getElementById("live-time");
  const now = new Date();
  let d = String(now.getDate()).padStart(2,"0");
  let m = String(now.getMonth()+1).padStart(2,"0");
  let y = now.getFullYear();
  let h = now.getHours();
  let min = String(now.getMinutes()).padStart(2,"0");
  let sec = String(now.getSeconds()).padStart(2,"0");
  let ampm = h>=12?"PM":"AM";
  h = (h%12)||12;
  el.textContent = `${d}-${m}-${y} ${h}:${min}:${sec} ${ampm}`;
}
setInterval(updateTime,1000);
updateTime();


/* ---------------- IP ---------------- */
fetch("https://api.ipify.org?format=json")
.then(r=>r.json())
.then(d=>document.getElementById("user-ip").textContent="IP: "+d.ip);

/* ---------------- MENU ---------------- */
function toggleMenu(){
  document.getElementById("mainMenu").classList.toggle("show");
}


</script>

</body>
</html>
