<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Deleted PAC Records ‚Äî PAC Management System</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<!-- ‚≠ê Favicon -->
<link rel="icon" type="image/png" href="assets/fav.png">
<link rel="apple-touch-icon" href="assets/fav.png">
<style>
/* ---------------- GLOBAL ---------------- */
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:'Poppins',sans-serif;
  background:linear-gradient(135deg,#6e00ff,#0057ff,#00e5ff);
  background-size:300% 300%;
  animation: aurora 25s ease infinite;
  color:#333;
  overflow-x:hidden;
}

@keyframes aurora {
  0%{background-position:0% 50%;}
  50%{background-position:100% 50%;}
  100%{background-position:0% 50%;}
}

/* SOFT GLOW CONTAINER */
.glass-box{
  backdrop-filter:blur(12px);
  background:rgba(255,255,255,0.20);
  border-radius:18px;
  box-shadow:0 10px 30px rgba(0,0,0,0.25);
  border:1px solid rgba(255,255,255,0.35);
}

/* ---------------- HEADER ---------------- */
header{
  background:rgba(0,0,0,0.45);
  backdrop-filter:blur(8px);
  color:#fff;
  padding:18px 40px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:sticky;
  top:0;z-index:1000;
  box-shadow:0 4px 25px rgba(0,0,0,0.45);
  border-bottom:1px solid rgba(255,255,255,0.3);
}

header h1{
  font-size:26px;
  display:flex;
  align-items:center;
  gap:10px;
}

nav a{
  color:white;
  margin-left:25px;
  font-weight:600;
  text-decoration:none;
  position:relative;
  transition:0.3s;
}

nav a:hover{
  color:#ffeb3b;
}

nav a::after{
  content:"";
  position:absolute;
  left:0;bottom:-4px;
  width:0;height:2px;
  background:#ffeb3b;
  transition:0.3s;
}

nav a:hover::after{
  width:100%;
}

.menu-toggle{
  display:none !important;
}

/* ---------------- MOBILE MENU ---------------- */
@media(max-width:768px){
  header{padding:12px 18px;}
  header h1{font-size:18px;gap:8px;}

  .menu-toggle{
    display:block !important;
    font-size:24px;
    cursor:pointer;
    color:#fff;
  }

  header nav{
    position:absolute;
    top:60px;left:0;
    width:100%;
    background:rgba(0,0,0,0.65);
    max-height:0;
    overflow:hidden;
    flex-direction:column;
    transition:max-height 0.35s ease;
    border-bottom-left-radius:20px;
    border-bottom-right-radius:20px;
  }

  header nav.show{
    max-height:450px;
  }

  header nav a{
    padding:14px 22px;
    margin:0;
    display:block;
    font-size:15px;
  }
}

/* ---------------- PAGE TITLE ---------------- */
.page-title{
  text-align:center;
  margin-top:40px;
  font-size:30px;
  color:white;
  font-weight:700;
  text-shadow:0 2px 10px rgba(0,0,0,0.4);
}

/* ---------------- STATS ---------------- */
.stats-bar{
  display:flex;
  justify-content:center;
  gap:20px;
  margin:20px auto;
  width:95%;
  flex-wrap:wrap;
}

.stat-card{
  background:rgba(255,255,255,0.15);
  padding:18px 25px;
  border-radius:14px;
  color:white;
  text-align:center;
  min-width:200px;
  box-shadow:0 5px 25px rgba(0,0,0,0.3);
  backdrop-filter:blur(10px);
  border:1px solid rgba(255,255,255,0.25);
}

.stat-card h3{
  font-size:26px;
}

/* ---------------- SEARCH ---------------- */
.search-bar{
  width:95%;
  max-width:650px;
  margin:25px auto;
}

.search-bar input{
  width:100%;
  padding:14px 18px;
  border-radius:10px;
  border:2px solid rgba(255,255,255,0.6);
  font-size:15px;
  outline:none;
  background:rgba(255,255,255,0.3);
  color:white;
}

.search-bar input::placeholder{
  color:white;
}

/* ---------------- FILTER ---------------- */
.filters{
  display:flex;
  gap:20px;
  margin:10px auto 20px;
  width:95%;
  flex-wrap:wrap;
  justify-content:center;
}

.filters select, .filters input{
  padding:10px 12px;
  border-radius:8px;
  background:rgba(255,255,255,0.3);
  border:2px solid rgba(255,255,255,0.5);
  color:white;
}

.filters option{
  color:black;
}

/* ---------------- TABLE ---------------- */
.table-container{
  width:95%;
  max-width:1400px;
  margin:auto;
  background:rgba(255,255,255,0.25);
  border-radius:18px;
  backdrop-filter:blur(10px);
  padding:20px;
  box-shadow:0 8px 35px rgba(0,0,0,0.25);
}

table{
  width:100%;
  border-collapse:collapse;
}

th{
  background:rgba(0,0,0,0.65);
  color:white;
  padding:12px;
  font-size:14px;
}

td{
  padding:10px;
  font-size:13px;
  color:white;
  border-bottom:1px solid rgba(255,255,255,0.2);
}

tr{
  transition:0.3s;
}

tr:hover{
  background:rgba(255,255,255,0.15);
}

/* ---------------- BUTTONS ---------------- */
.action-btn{
  padding:7px 12px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  color:white;
  font-size:14px;
}

.restore-btn{background:#28a745;}
.restore-btn:hover{background:#1f8b36;}

.del-btn{background:#d93025;}
.del-btn:hover{background:#b72319;}

/* ---------------- MOBILE CARD ---------------- */
.mobile-card{
  display:none;
  width:94%;
  margin:15px auto;
  padding:18px;
  border-radius:16px;
  background:rgba(255,255,255,0.22);
  backdrop-filter:blur(10px);
  border-left:4px solid #00e5ff;
  color:white;
  box-shadow:0 8px 20px rgba(0,0,0,0.35);
}

.mobile-card p{margin:4px 0;font-size:14px;}

@media(max-width:768px){
  table{display:none;}
  .mobile-card{display:block;}
}

/* ---------------- FOOTER ---------------- */
footer{
  margin-top:60px;
  text-align:center;
  padding:25px;
  color:white;
  background:rgba(0,0,0,0.45);
  backdrop-filter:blur(10px);
  border-top:1px solid rgba(255,255,255,0.25);
}

/* VIEW MODAL */
.modal-bg {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.45);
  backdrop-filter: blur(8px);
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.modal-box {
  background: rgba(255,255,255,0.15);
  padding: 25px;
  width: 90%;
  max-width: 450px;
  border-radius: 15px;
  color: white;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  backdrop-filter: blur(12px);
  border: 1px solid rgba(255,255,255,0.3);
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from {opacity:0; transform: scale(0.92);}
  to {opacity:1; transform: scale(1);}
}

.modal-box h2 {
  font-size: 20px;
  margin-bottom: 10px;
  text-align: center;
}

#modalContent p {
  margin: 6px 0;
  font-size: 15px;
}

.close-btn {
  margin-top: 12px;
  display: block;
  width: 100%;
  padding: 10px;
  background: #d93025;
  border: none;
  color: white;
  border-radius: 8px;
  font-size: 16px;
  cursor: pointer;
}
.close-btn:hover {
  background: #b72319;
}

/* view button style */
.view-btn {
  background: #cfe23a;
}
.view-btn:hover {
  background: #ebc033;
}

/* PAGINATION BUTTONS */
.page-btn {
  padding: 8px 16px;
  margin: 0 6px;
  border: 1px solid rgba(255,255,255,0.35);
  border-radius: 10px;
  cursor: pointer;
  background: rgba(255,255,255,0.18);
  color: white;
  backdrop-filter: blur(10px);
  font-size: 15px;
  font-weight: 600;
  transition: 0.3s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
}

/* HOVER EFFECT */
.page-btn:hover {
  background: rgba(255,255,255,0.35);
  transform: translateY(-2px);
  box-shadow: 0 6px 18px rgba(0,0,0,0.35);
}

/* ACTIVE PAGE BUTTON */
.page-btn.active {
  background: #00e5ff;
  color: #000;
  border-color: #00e5ff;
  box-shadow: 0 0 12px #00e5ff;
}

/* DISABLED BUTTON */
.page-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
  transform: none;
}

/* PAGE SELECT DROPDOWN */
.page-select {
  padding: 8px 14px;
  border-radius: 10px;
  margin-left: 15px;
  background: rgba(255,255,255,0.25);
  border: 1px solid rgba(255,255,255,0.35);
  color: white;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  backdrop-filter: blur(10px);
  transition: 0.3s;
  appearance: none;
  -webkit-appearance: none;
  position: relative;
}

/* CUSTOM ARROW */
.page-select::after {
  content: "‚ñº";
  font-size: 12px;
  color: white;
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
}

/* DROPDOWN OPTIONS */
.page-select option {
  background: #007bff;
  color: white;
  padding: 10px;
}

/* ============================
      MOBILE PAGINATION FIX
   ============================ */
@media (max-width: 768px) {

  /* Pagination wrapper spacing */
  #pagination {
    display: flex;
    flex-direction: column;
    gap: 12px;
    align-items: center;
    justify-content: center;
  }

  /* Page numbers container */
  #pageNumbers {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
  }

  /* Buttons resize for mobile */
  .page-btn {
    min-width: 55px;
    padding: 8px 12px;
    font-size: 14px;
  }

  /* Move dropdown below buttons */
  .page-select {
    width: 90px;
    text-align: center;
    margin-left: 0;
  }
}

/* SELECT WRAPPER FOR CUSTOM ARROW */
/* WRAPPER FOR CUSTOM DROPDOWN */
.select-wrapper {
  position: relative;
  display: inline-block;
}

/* FIX SELECT PADDING SO ARROW HAS SPACE */
.page-select {
  padding-right: 35px !important; /* More space for arrow */
}

/* CUSTOM ARROW */
.select-wrapper::after {
  content: "‚ñº";
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: white;
  pointer-events: none;
  font-size: 13px;
  opacity: 0.9;
}


</style>
</head>
<body>

<!-- HEADER -->
<header>
  <h1><i class="fa-solid fa-database"></i> PAC Management</h1>
  <div class="menu-toggle" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></div>
  <nav id="mainMenu"></nav>
</header>

<h2 class="page-title">Deleted PAC Records</h2>

<!-- STAT CARDS -->
<div class="stats-bar">
  <div class="stat-card"><h3 id="totalCount">0</h3> Total Deleted</div>
  <div class="stat-card"><h3 id="todayCount">0</h3>Today Deleted</div>
  <div class="stat-card"><h3 id="todayAmount">‚Çπ0</h3>Total Deleted Amount</div>
  <div class="stat-card"><h3 id="dbSize">0 KB</h3>DB Size</div>
</div>

<!-- SEARCH -->
<div class="search-bar"><input id="searchInput" placeholder="Search PAC, UCL No, Owner Name..."></div>

<!-- FILTERS -->
<div class="filters">
  <input type="date" id="fromDate">
  <input type="date" id="toDate">
  <select id="uclFilter">
  <option value="">Filter by UCL ID</option>
</select>

</div>

<!-- Desktop TABLE View -->
<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>UCL No</th>
        <th>CSC Ref</th>
        <th>PAC No</th>
        <th>Amount</th>
        <th>Date</th>
        <th>Time</th>
        <th>Deleted</th>
        <th>Owner</th>
        <th>Deleted IP</th>
        <th>Deleted ID</th>
        <th>View</th>
        <th>Restore</th>
        <th>Delete</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<!-- MOBILE TABLE VIEW-->
<div id="mobileCards"></div>

<!-- PAGINATION -->
<div id="pagination" style="text-align:center; margin:25px 0; color:white;">
  <button id="prevPage" class="page-btn">Prev</button>
  <span id="pageNumbers"></span>
  <button id="nextPage" class="page-btn">Next</button>
<div class="select-wrapper">
  <select id="rowsPerPage" class="page-select">
    <option value="10">10</option>
    <option value="20">20</option>
    <option value="50">50</option>
  </select>
  </div>
</div>

<!-- VIEW MODAL -->
<div id="viewModal" class="modal-bg">
  <div class="modal-box">
    <h2>Deleted PAC Details</h2>
    <div id="modalContent"></div>
    <button class="close-btn" onclick="closeModal()">Close</button>
  </div>
</div>

<!-- FOOTER -->
<footer>
  &copy; 2025 PAC Management System
  <br><span id="live-time"></span> |
  <span id="user-ip"></span>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getFirestore, collection, query, orderBy, onSnapshot, doc, deleteDoc, setDoc }
from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCE2_x5xvW3wCsOx6jo9-ZhNOhgWm86cPY",
  authDomain: "mrsamrat08.firebaseapp.com",
  projectId: "mrsamrat08",
  storageBucket: "mrsamrat08.appspot.com",
  messagingSenderId: "525481767881",
  appId: "1:525481767881:web:6fd53162b242709890ae18"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------------- LOAD NAV ---------------- */
function loadNav() {
  const menu = document.getElementById("mainMenu");
  const q = query(collection(db, "pacnav"), orderBy("order"));

  onSnapshot(q, snap => {
    menu.innerHTML = "";
    snap.forEach(doc => {
      const v = doc.data();
      menu.innerHTML += `<a href="${v.url}"><i class="${v.icon}"></i> ${v.title}</a>`;
    });
  });
}
loadNav();

/* ---------------- LOAD DELETED PAC DATA ---------------- */
const tableBody = document.getElementById("tableBody");
const mobileCards = document.getElementById("mobileCards");

let allPAC = [];

let currentPage = 1;
let rowsPerPageValue = 10;

// For filtered results
function getFilteredData() {
  const search = document.getElementById("searchInput").value.toLowerCase();
  const from = document.getElementById("fromDate").value;
  const to = document.getElementById("toDate").value;
  const uclFilter = document.getElementById("uclFilter").value;

  return allPAC.filter(d => {
    let txt = JSON.stringify(d).toLowerCase();

    if (search && !txt.includes(search)) return false;
    if (uclFilter && String(d.uclNo).trim() !== String(uclFilter).trim()) return false;

    // Date filter
    let delDate = parseDate(formatDeleteDate(
      d.deletedAt || d.deletedAtTimestamp || d.deleteTime
    ));
    let fromDate = from ? new Date(from) : null;
    let toDate = to ? new Date(to) : null;

    if (fromDate && (!delDate || delDate < fromDate)) return false;
    if (toDate && (!delDate || delDate > toDate)) return false;

    return true;
  });
}


function renderPagination() {
  const filtered = getFilteredData();
  const totalPages = Math.ceil(filtered.length / rowsPerPageValue);

  const pageNumbers = document.getElementById("pageNumbers");
  pageNumbers.innerHTML = "";

  if (totalPages <= 1) return;

  function addBtn(p) {
    pageNumbers.innerHTML += `
      <button onclick="goToPage(${p})"
      class="page-btn ${p === currentPage ? "active" : ""}">
        ${p}
      </button>`;
  }

  // Always show first page
  addBtn(1);

  // Show "..." if needed
  if (currentPage > 4) {
    pageNumbers.innerHTML += `<span style="color:white; margin:0 6px;">...</span>`;
  }

  // Pages around the current page (2 before, 2 after)
  for (let p = currentPage - 2; p <= currentPage + 2; p++) {
    if (p > 1 && p < totalPages) {
      addBtn(p);
    }
  }

  // Show "..." before last page
  if (currentPage < totalPages - 3) {
    pageNumbers.innerHTML += `<span style="color:white; margin:0 6px;">...</span>`;
  }

  // Always show last page if not same as first
  if (totalPages > 1) addBtn(totalPages);
}



function loadPAC() {
  const q = query(collection(db, "delete_pac"), orderBy("pacNo", "desc"));

  onSnapshot(q, snapshot => {

    allPAC = []; // only reset array

    let todayISO = new Date().toISOString().slice(0, 10);

    // UNIVERSAL DATE PARSER
    function extractISO(d) {

      if (!d) return "";

      if (typeof d === "number") {
        return new Date(d).toISOString().slice(0, 10);
      }

      if (d.includes("T") && d.includes("Z")) {
        return new Date(d).toISOString().slice(0, 10);
      }

      if (d.includes("/")) {
        let datePart = d.split(",")[0];
        let [day, month, year] = datePart.split("/");
        return `${year}-${month.padStart(2,"0")}-${day.padStart(2,"0")}`;
      }

      if (d.includes("-")) {
        let datePart = d.split(" ")[0];
        let [dd, mm, yyyy] = datePart.split("-");
        return `${yyyy}-${mm.padStart(2,"0")}-${dd.padStart(2,"0")}`;
      }

      return "";
    }

    // ===== COUNTING VARIABLES =====
    let todayCount = 0;
    let pacGroups = {};
    let dbBytes = 0;

    // ===== UCL SET =====
    let uclSet = new Set();

    snapshot.forEach(doc => {

      const d = doc.data();
      allPAC.push(d); // store data for pagination

      // Collect UCL IDs
      if (d.uclNo) uclSet.add(d.uclNo);

      // Calculate DB size
      dbBytes += JSON.stringify(d).length;

      // Total amount
      if (!pacGroups[d.pacNo]) {
        pacGroups[d.pacNo] = { count: 0, amount: Number(d.amount) };
      }
      pacGroups[d.pacNo].count++;

      // Today delete count
      const delISO = extractISO(
        d.deletedAt ||
        d.deletedAtTimestamp ||
        d.deleteTime
      );

      if (delISO === todayISO) {
        todayCount++;
      }
    });

    // ===== UPDATE UCL FILTER DROPDOWN =====
    const uclSelect = document.getElementById("uclFilter");
    if (uclSelect) {
      uclSelect.innerHTML = `<option value="">Filter by UCL ID</option>`;
      uclSet.forEach(u => {
        const cleanUCL = String(u).trim();
        uclSelect.innerHTML += `<option value="${cleanUCL}">${cleanUCL}</option>`;
      });
    }

    // ===== TOTAL AMOUNT =====
    let totalAmount = 0;
    Object.values(pacGroups).forEach(p => {
      totalAmount += p.count * p.amount;
    });

    function formatSize(bytes) {
      if (bytes < 1024) return bytes + " B";
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + " KB";
      return (bytes / (1024 * 1024)).toFixed(2) + " MB";
    }

    let dbSize = formatSize(dbBytes);

    // ===== UPDATE UI =====
    document.getElementById("totalCount").textContent = allPAC.length;
    document.getElementById("todayCount").textContent = todayCount;
    document.getElementById("todayAmount").textContent = "‚Çπ" + totalAmount;
    document.getElementById("dbSize").textContent = dbSize;

    // üî• PAGINATION NOW CONTROLS RENDERING
    renderPage();
  });
}

loadPAC();

window.renderPage = function () {
  const filtered = getFilteredData();

  const start = (currentPage - 1) * rowsPerPageValue;
  const end = start + rowsPerPageValue;

  const displayData = filtered.slice(start, end);

  // Clear displays
  tableBody.innerHTML = "";
  mobileCards.innerHTML = "";

  // Render table + mobile cards
  displayData.forEach(d => {
    addRow(d);
    addCard(d);
  });

  // Render page buttons
  renderPagination();
};

// ‚úÖ ADD THIS FIX
window.goToPage = function(p) {
  currentPage = p;
  renderPage();
};

// PREVIOUS PAGE BUTTON
document.getElementById("prevPage").onclick = function () {
  if (currentPage > 1) {
    currentPage--;
    renderPage();
  }
};

// NEXT PAGE BUTTON
document.getElementById("nextPage").onclick = function () {
  const filtered = getFilteredData();
  const totalPages = Math.ceil(filtered.length / rowsPerPageValue);

  if (currentPage < totalPages) {
    currentPage++;
    renderPage();
  }
};

// ROWS PER PAGE SELECT
document.getElementById("rowsPerPage").onchange = function () {
  rowsPerPageValue = Number(this.value);
  currentPage = 1;
  renderPage();
};


/* ---------------- ADD TABLE ROW ---------------- */
function addRow(d) {

  let deletedValue = formatDeleteDate(
    d.deletedAt || 
    d.deletedAtTimestamp || 
    d.deleteTime
  );

  tableBody.innerHTML += `
<tr>
  <td>${d.uclNo}</td>
  <td>${d.cscRef}</td>
  <td>${d.pacNo}</td>
  <td>${d.amount}</td>
  <td>${d.entryDate}</td>
  <td>${d.entryTime}</td>
  <td>${deletedValue}</td>
  <td>${d.uclOwnerName}</td>
  <td>${d.deleteIP}</td>
  <td>${d.deleteViewId}</td>
  <td><button class="action-btn view-btn" onclick='viewPAC(${JSON.stringify(d)})'>üëÅ</button></td>
  <td><button class="action-btn restore-btn" onclick='restorePAC(${JSON.stringify(d)})'>‚Ü©</button></td>
  <td><button class="action-btn del-btn" onclick="deletePAC('${d.pacNo}')">‚úñ</button></td>
</tr>`;
}

/* ---------------- ADD MOBILE CARD ---------------- */ 
function addCard(d) {

  let deletedValue = formatDeleteDate(
    d.deletedAt || 
    d.deletedAtTimestamp || 
    d.deleteTime
  );

mobileCards.innerHTML += `
<div class="mobile-card">
  <p><b>UCL:</b> ${d.uclNo}</p>
  <p><b>PAC:</b> ${d.pacNo}</p>
  <p><b>Amount:</b> ${d.amount}</p>
  <p><b>Date:</b> ${d.entryDate}</p>
  <p><b>Time:</b> ${d.entryTime}</p>
  <p><b>Deleted:</b> ${deletedValue}</p>
  <p><b>Owner:</b> ${d.uclOwnerName}</p>
  <p><b>Deleted IP:</b> ${d.deleteIP}</p>
  <p><b>Deleted ID:</b> ${d.deleteViewId}</p>
  <button class="action-btn view-btn" onclick='viewPAC(${JSON.stringify(d)})'>View</button>
  <button class="action-btn restore-btn" onclick='restorePAC(${JSON.stringify(d)})'>Restore</button>
  <button class="action-btn del-btn" onclick="deletePAC('${d.pacNo}')">Delete</button>
</div>`;
}

/* ---------------- RESTORE ---------------- */
window.restorePAC = async function(data) {
  if (!confirm(`Restore PAC ${data.pacNo}?`)) return;

  // Remove delete-only fields
  delete data.deleteIP;
  delete data.deleteViewId;
  delete data.deletedAt;
  delete data.deletedAtTimestamp;
  delete data.deleteTime;

  // (Optional but recommended) ensure required fields exist
  if (!data.createdAt) {
    data.createdAt = new Date().toISOString();
  }

  await setDoc(doc(db, "pac_entries", data.pacNo), data);
  await deleteDoc(doc(db, "delete_pac", data.pacNo));

  alert("PAC Restored!");
};

/* ---------------- DELETE ---------------- */
window.deletePAC = async function(pacNo) {
  if (!confirm(`Permanently delete PAC ${pacNo}?`)) return;

  await deleteDoc(doc(db, "delete_pac", pacNo));

  alert("Permanently Deleted!");
};

/* ---------------- universal delete formatter ---------------- */
function formatDeleteDate(d) {

  if (!d) return "‚Äî";

  let date;

  // CASE 1: Epoch timestamp number
  if (typeof d === "number") {
    date = new Date(d);
  }

  // CASE 2: ISO string
  else if (d.includes("T") && d.includes("Z")) {
    date = new Date(d);
  }

  // CASE 3: "3/12/2025, 8:16:57 pm"
  else if (d.includes("/")) {
    date = new Date(d);
  }

  // CASE 4: "24-12-2025 10:52 AM"
  else if (d.includes("-")) {
    let [datePart, timePart] = d.split(" ");
    let [dd, mm, yyyy] = datePart.split("-");
    date = new Date(`${yyyy}-${mm}-${dd} ${timePart}`);
  }

  else {
    return d;
  }

  // FORMAT OUTPUT ‚Üí DD-MM-YYYY HH:mm:ss AM/PM
  let day = String(date.getDate()).padStart(2, "0");
  let month = String(date.getMonth() + 1).padStart(2, "0");
  let year = date.getFullYear();

  let hours = date.getHours();
  let minutes = String(date.getMinutes()).padStart(2, "0");
  let seconds = String(date.getSeconds()).padStart(2, "0");

  let ampm = hours >= 12 ? "PM" : "AM";
  hours = hours % 12;
  hours = hours ? hours : 12;
  hours = String(hours).padStart(2, "0");

  return `${day}-${month}-${year} ${hours}:${minutes}:${seconds} ${ampm}`;
}

/* ---------------- PARSE DATE FOR FILTERS ---------------- */
function parseDate(x) {
  if (!x) return null;

  if (!isNaN(Date.parse(x))) return new Date(x);

  if (x.includes("-")) {
    let [dd, mm, yy] = x.split("-").map(s => s.trim());
    return new Date(`${yy}-${mm}-${dd}`);
  }

  if (x.includes("/")) {
    let [dd, mm, yy] = x.split("/");
    return new Date(`${yy}-${mm}-${dd}`);
  }

  return null;
}


/* ---------------- FINAL SEARCH + FILTER FUNCTION ---------------- */
function runFilters() {
  const search = document.getElementById("searchInput").value.toLowerCase();
  const from = document.getElementById("fromDate").value;
  const to = document.getElementById("toDate").value;
  const uclFilter = document.getElementById("uclFilter").value;


  const isMobile = window.innerWidth <= 768;

  const fromDate = from ? new Date(from) : null;
  const toDate = to ? new Date(to) : null;

 /* ===== MOBILE: CARD FILTER ===== */
const cards = document.querySelectorAll(".mobile-card");

cards.forEach(card => {
  let txt = card.innerText.toLowerCase();
  let match = txt.match(/deleted:\s*(.*)/i);
  let delDate = match ? parseDate(match[1].trim()) : null;

  let show = true;

  if (search && !txt.includes(search)) show = false;
  if (uclFilter && !txt.includes(String(uclFilter).toLowerCase())) show = false;
  if (fromDate && (!delDate || delDate < fromDate)) show = false;
  if (toDate && (!delDate || delDate > toDate)) show = false;

  card.style.display = show ? "block" : "none";
});

currentPage = 1;
renderPage();


}

window.viewPAC = function(d) {

  const modal = document.getElementById("viewModal");
  const content = document.getElementById("modalContent");

  content.innerHTML = `
    <p><b>UCL No:</b> ${d.uclNo}</p>
    <p><b>CSC Ref:</b> ${d.cscRef}</p>
    <p><b>PAC No:</b> ${d.pacNo}</p>
    <p><b>Amount:</b> ${d.amount}</p>
    <p><b>Date:</b> ${d.entryDate}</p>
    <p><b>Time:</b> ${d.entryTime}</p>
    <p><b>Deleted:</b> ${formatDeleteDate(
      d.deletedAt || d.deletedAtTimestamp || d.deleteTime
    )}</p>
    <p><b>Owner:</b> ${d.uclOwnerName}</p>
    <p><b>Deleted IP:</b> ${d.deleteIP}</p>
    <p><b>Deleted ID:</b> ${d.deleteViewId}</p>
    <p><b>Purpose:</b> ${d.purpose}</p>
    <p><b>PAC Saved IP:</b> ${d.savedFromIp}</p>
    <p><b>UCL Owner IP:</b> ${d.uclOwnerIp}</p>
    <p><b>Purpose:</b> ${d.purpose}</p>
  `;

  modal.style.display = "flex";
};

window.closeModal = function() {
  document.getElementById("viewModal").style.display = "none";
};


/* ---------------- LISTENERS ---------------- */
document.getElementById("searchInput").addEventListener("keyup", runFilters);
document.getElementById("fromDate").addEventListener("change", runFilters);
document.getElementById("toDate").addEventListener("change", runFilters);
document.getElementById("uclFilter").addEventListener("change", runFilters);

</script>

<script>
/* ---------------- TIME ---------------- */
function updateTime() {
  const el = document.getElementById("live-time");
  const now = new Date();
  let d = String(now.getDate()).padStart(2,"0");
  let m = String(now.getMonth()+1).padStart(2,"0");
  let y = now.getFullYear();
  let h = now.getHours();
  let min = String(now.getMinutes()).padStart(2,"0");
  let sec = String(now.getSeconds()).padStart(2,"0");
  let ampm = h>=12?"PM":"AM";
  h = (h%12)||12;
  el.textContent = `${d}-${m}-${y} ${h}:${min}:${sec} ${ampm}`;
}
setInterval(updateTime,1000);
updateTime();


/* ---------------- IP ---------------- */
fetch("https://api.ipify.org?format=json")
.then(r=>r.json())
.then(d=>document.getElementById("user-ip").textContent="IP: "+d.ip);

/* ---------------- MENU ---------------- */
function toggleMenu(){
  document.getElementById("mainMenu").classList.toggle("show");
}


</script>

</body>
</html>
