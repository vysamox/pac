<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Register UCL Owner ‚Äî PAC Management</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root{
  --accent1:#007bff; --accent2:#00c6ff; --glass:rgba(255,255,255,0.78);
  --shadow:0 10px 25px rgba(0,0,0,0.12); --radius:14px; --max-w:960px;
}
body{margin:0;font-family:'Segoe UI',Arial;background:linear-gradient(135deg,#eef6ff,#e0efff);color:#0b2340}
header{background:rgba(0,123,255,0.9);backdrop-filter:blur(8px);color:#fff;padding:12px 18px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:999}
header .left{display:flex;align-items:center;gap:12px}
header img.logo{width:36px;height:36px;border-radius:8px;object-fit:cover;border:2px solid rgba(255,255,255,0.15)}
header h1{margin:0;font-size:18px}
nav a{color:#fff;text-decoration:none;margin-left:14px;font-weight:700}
.page{max-width:var(--max-w);margin:36px auto;padding:0 18px 90px}
.grid{display:flex;flex-direction:column;gap:28px}
.card{background:var(--glass);border-radius:var(--radius);padding:22px;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.5)}
.card h2{margin:0 0 12px 0;color:#051133}
label{display:block;margin-top:12px;font-weight:700;color:#06438a;font-size:13px}
input[type="text"],textarea{width:100%;padding:11px;border-radius:10px;border:1.4px solid #cfd8e3;margin-top:6px;background:#fff;box-sizing:border-box;transition:.18s}
textarea{min-height:76px;resize:vertical}
.menu-toggle {
  display: none !important;
}
input:focus,textarea:focus{outline:none;border-color:var(--accent1);box-shadow:0 6px 18px rgba(0,123,255,0.12)}
.actions{display:flex;gap:12px;margin-top:16px}
.btn{flex:1;padding:12px;border-radius:12px;border:none;color:#fff;background:linear-gradient(135deg,var(--accent1),var(--accent2));cursor:pointer;font-weight:700;box-shadow:0 8px 22px rgba(0,123,255,0.18)}
.btn.secondary{background:#fff;color:var(--accent1);border:1px solid rgba(0,123,255,0.12)}
.list-card{background:var(--glass);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.45);width:100%;max-height:62vh;overflow:auto}
.list-top{display:flex;align-items:center;justify-content:space-between;gap:8px}
.search input{padding:9px;border-radius:10px;border:1px solid #cfd8e3}
table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
th,td{padding:8px;border-bottom:1px solid rgba(10,20,40,0.05);text-align:left}
.row-actions{display:flex;gap:8px;justify-content:flex-end}
.pill{display:inline-block;padding:6px 8px;border-radius:10px;font-weight:700;font-size:12px}
.pill.new{background:#e6fff0;color:#006b2f}
.pill.exists{background:#fff3e6;color:#9a4a00}
.toast{position:fixed;right:20px;bottom:20px;z-index:2000;background:#072445;color:#fff;padding:12px 14px;border-radius:10px;opacity:0;transform:translateY(12px);transition:all .25s}
.toast.show{opacity:1;transform:translateY(0)}
.otp-modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(6,10,26,0.5);display:flex;align-items:center;justify-content:center;z-index:3000;visibility:hidden;opacity:0;transition:all .18s}
.otp-modal.show{visibility:visible;opacity:1}
.otp-panel{width:380px;max-width:94%;background:#fff;border-radius:12px;padding:16px;box-shadow:0 20px 50px rgba(3,10,30,0.25)}
.otp-panel h3{margin:0 0 6px 0;color:#04224a}
.otp-panel p{margin:0 0 12px;color:#41536b;font-size:13px}
.otp-panel input{width:95%;padding:10px;border:1px solid #d8e2ef;border-radius:8px}
.otp-actions{display:flex;gap:8px;margin-top:10px}

@media(max-width:720px){.otp-panel{width:92%}}
footer{background:var(--accent1);color:#fff;padding:12px;text-align:center;position:fixed;bottom:0;left:0;width:100%}

/* ---------------- MOBILE HEADER (FINAL FIXED VERSION) ---------------- */
@media (max-width: 768px) {

  header {
    padding: 12px 18px;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    height: 60px;
  }

  header h1 {
    font-size: 18px;
    gap: 8px;
    margin: 0;
    white-space: nowrap;
  }

  header h1 i {
    font-size: 18px;
  }

  .menu-toggle {
    display: block !important;
    font-size: 24px;
    cursor: pointer;
    color: #fff;
  }

  /* Mobile nav dropdown */
  header nav {
    position: absolute;
    top: 60px;
    left: 0;
    width: 100%;
    background: rgba(0,123,255,0.95);
    max-height: 0;
    overflow: hidden;
    flex-direction: column;
    transition: max-height 0.35s ease;
    border-bottom-left-radius: 20px;
    border-bottom-right-radius: 20px;
    padding: 0;
  }

  header nav.show {
    max-height: 450px;
  }

  header nav a {
    padding: 14px 22px;
    margin: 0;
    display: block;
    font-size: 15px;
  }
  }

  /* MOBILE TABLE FIX */
@media (max-width: 768px) {
  #ownersTableWrap {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  table {
    min-width: 600px; /* ensures layout never breaks */
  }
  #ownersTableWrap {
  width: 100%;
  overflow-x: auto;
}


  .list-card {
    padding: 8px;
  }
}

/* MOBILE FOOTER FIX */
@media (max-width: 768px) {
  footer {
    padding: 10px 5px;
    font-size: 12px;
    height: auto;
    text-align: center;
  }

  #footer-ip {
    font-size: 12px;
    margin-left: 0 !important;
    margin-top: 4px;
    opacity: 0.9;
    word-break: break-all;
  }
}

</style>
</head>
<body>

<header>
  <div class="left">
    <div>
      <h1><i class="fa-solid fa-database"></i> PAC Management</h1>
      <div style="font-size:12px;opacity:.9">Register UCL Owner ‚Äî Telegram 2FA</div>
    </div>
    
  </div>
    <!-- Mobile Menu Toggle -->
  <div class="menu-toggle" onclick="toggleMenu()">
    <i class="fa-solid fa-bars"></i>
  </div>
 <nav id="mainMenu">
  </nav>
</header>

<div class="page">
  <div class="grid">

    <!-- FORM -->
    <div class="card" id="formCard">
      <h2>UCL Owner Form</h2>

      <label for="ownerName">Owner Name *</label>
      <input id="ownerName" type="text" placeholder="Enter owner full name">

      <label for="uclId">UCL ID *</label>
      <input id="uclId" type="text" placeholder="Enter unique UCL ID (no spaces)">

      <label for="ipAddress">IP Address</label>
      <input id="ipAddress" type="text" placeholder="Auto fetched ‚Äî editable">

      <label for="address">Address *</label>
      <textarea id="address" placeholder="Enter full address"></textarea>

      <div class="small-note">* Required fields</div>

      <div class="actions">
        <button id="saveBtn" class="btn"><i class="fa-solid fa-floppy-disk"></i> Save / Update</button>
        <button id="clearBtn" class="btn secondary"><i class="fa-solid fa-eraser"></i> Clear</button>
      </div>

      <div style="margin-top:10px;display:flex;gap:12px;align-items:center">
        <div class="pill new" id="live-status">Checking IP...</div>
        <div style="font-size:13px;color:#30537a">UCL ID locks during edit to prevent accidental change.</div>
      </div>
    </div>

    <!-- LIST -->
    <div class="list-card">
      <div class="list-top">
        <div style="display:flex;gap:10px;align-items:center">
          <strong>UCL Owners</strong>
          <span class="muted" id="totalCount">(0)</span>
        </div>
        <div class="search">
          <input id="searchInput" placeholder="Search by UCL ID / Name / IP">
          <button id="refreshBtn" class="btn secondary" title="Refresh"><i class="fa-solid fa-arrows-rotate"></i></button>
        </div>
      </div>

      <div id="ownersTableWrap">
        <table id="ownersTable" aria-live="polite">
          <thead>
            <tr><th>UCL ID</th><th>Owner</th><th>IP</th><th style="width:160px">Actions</th></tr>
          </thead>
          <tbody id="ownersTbody"></tbody>
        </table>
      </div>

      <div id="emptyState" style="display:none;padding:12px;text-align:center;color:#55607a">No UCL owners found</div>
    </div>

  </div>
</div>

<!-- OTP Modal -->
<div id="otpModal" class="otp-modal" aria-hidden="true">
  <div class="otp-panel" role="dialog" aria-modal="true">
    <h3 id="otpTitle">Enter OTP</h3>
    <p id="otpDesc">A 6-digit code was sent to Telegram. Expires in 60 seconds.</p>
    <input id="otpInput" maxlength="6" inputmode="numeric" placeholder="Enter OTP">
    <div class="otp-actions">
      <button id="otpConfirmBtn" class="btn">Confirm</button>
      <button id="otpCancelBtn" class="btn secondary">Cancel</button>
    </div>
    <div id="otpTimerText" style="margin-top:8px;color:#55607a;font-size:13px"></div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<footer>
  ¬© 2025 PAC Management System. All rights reserved.
  <span id="footer-ip" style="margin-left:8px">IP: Loading...</span>
</footer>


<!-- SCRIPT -->
 <script>// Mobile menu toggle
function toggleMenu() {
  document.getElementById("mainMenu").classList.toggle("show");
}
</script>
<script type="module">
/* ============================
   TELEGRAM 2FA + FIRESTORE PAGE
   ============================ */

import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, deleteDoc, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

/* ----------------------
   CONFIG (you provided)
   ---------------------- */
const TELEGRAM_BOT_TOKEN = "7607621792:AAHhgqpQ-ZK4Sf1iZySZHrKHoF9eGaBbxDs";
const TELEGRAM_CHAT_ID  = "-1003045536794";

const firebaseConfig = {
  apiKey: "AIzaSyCE2_x5xvW3wCsOx6jo9-ZhNOhgWm86cPY",
  authDomain: "mrsamrat08.firebaseapp.com",
  projectId: "mrsamrat08",
  storageBucket: "mrsamrat08.appspot.com",
  messagingSenderId: "525481767881",
  appId: "1:525481767881:web:6fd53162b242709890ae18"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ----------------------
   ELEMENTS
   ---------------------- */
const ownerName = document.getElementById("ownerName");
const uclId = document.getElementById("uclId");
const ipAddress = document.getElementById("ipAddress");
const address = document.getElementById("address");
const saveBtn = document.getElementById("saveBtn");
const clearBtn = document.getElementById("clearBtn");
const ownersTbody = document.getElementById("ownersTbody");
const totalCount = document.getElementById("totalCount");
const toast = document.getElementById("toast");
const liveStatus = document.getElementById("live-status");
const footerIp = document.getElementById("footer-ip");
const searchInput = document.getElementById("searchInput");
const refreshBtn = document.getElementById("refreshBtn");
const emptyState = document.getElementById("emptyState");

// OTP modal
const otpModal = document.getElementById("otpModal");
const otpInput = document.getElementById("otpInput");
const otpConfirmBtn = document.getElementById("otpConfirmBtn");
const otpCancelBtn = document.getElementById("otpCancelBtn");
const otpTimerText = document.getElementById("otpTimerText");
const otpTitle = document.getElementById("otpTitle");
const otpDesc = document.getElementById("otpDesc");

/* ----------------------
   STATE
   ---------------------- */
let editingId = null;
let ownersCache = {};
let unsubscribeSnapshot = null;

// pending OTPs: actionKey -> { otp, expiresAt, actionType, id, payload, changedFields, oldData }
const pendingOTPs = {};
const OTP_TTL_MS = 60 * 1000; // 1 minute

/* ----------------------
   HELPERS
   ---------------------- */
function showToast(msg, ok=true){
  toast.textContent = msg;
  toast.style.background = ok ? "linear-gradient(90deg,#0b6cff,#00c6ff)" : "#8a1b1b";
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"), 3000);
}

function escapeHtml(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

function clearForm(){
  ownerName.value = "";
  uclId.value = "";
  ipAddress.value = window.userIP || "";
  address.value = "";
  editingId = null;
  uclId.disabled = false;
  saveBtn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Save / Update';
  liveStatus.className = "pill new";
  liveStatus.textContent = "Ready";
}

/* ----------------------
   IP FETCH (auto-fill editable)
   ---------------------- */
async function fetchIP(){
  try {
    const r = await fetch("https://api.ipify.org?format=json");
    const j = await r.json();
    if (j.ip) { window.userIP = j.ip; ipAddress.value = j.ip; footerIp.textContent = j.ip; liveStatus.textContent = "IP detected"; return; }
  } catch(e){
    try {
      const cf = await fetch("https://www.cloudflare.com/cdn-cgi/trace");
      const txt = await cf.text();
      const ip = txt.match(/ip=(.*)/)?.[1]?.trim();
      window.userIP = ip || "Unavailable"; ipAddress.value = window.userIP; footerIp.textContent = window.userIP;
      liveStatus.textContent = window.userIP==="Unavailable"?"IP unavailable":"IP detected";
      return;
    } catch {
      window.userIP = "Unavailable"; ipAddress.value = "Unavailable"; footerIp.textContent = "Unavailable";
      liveStatus.textContent = "IP unavailable";
    }
  }
}
fetchIP();

/* ----------------------
   VALIDATION
   ---------------------- */
function validateForm(){
  if (!ownerName.value.trim()){ showToast("Owner name required", false); ownerName.focus(); return false; }
  if (!uclId.value.trim()){ showToast("UCL ID required", false); uclId.focus(); return false; }
  if (/\s/.test(uclId.value)) { showToast("UCL ID cannot contain spaces", false); uclId.focus(); return false; }
  if (!address.value.trim()){ showToast("Address required", false); address.focus(); return false; }
  return true;
}

/* ----------------------
   TELEGRAM SEND (client-side)
   ---------------------- */
async function sendToTelegram(text){
  const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
  try {
    const res = await fetch(url, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text, parse_mode: "HTML" })
    });
    const j = await res.json();
    if (!j.ok) throw new Error(j.description || "Telegram error");
    return true;
  } catch (err){
    console.error("Telegram send error:", err);
    throw err;
  }
}

/* ----------------------
   OTP UTIL
   ---------------------- */
function genOtp(){ return Math.floor(100000 + Math.random()*900000).toString(); }

function openOtpModal(actionKey, actionLabel){
  otpInput.value = "";
  otpModal.classList.add("show");
  otpModal.setAttribute("aria-hidden","false");
  otpConfirmBtn.dataset.actionKey = actionKey;
  otpTitle.textContent = `Enter OTP to confirm ${actionLabel}`;
  otpDesc.textContent = `A 6-digit code was sent to Telegram. It expires in 60 seconds.`;
  startOtpTimer(actionKey);
  otpInput.focus();
}

function closeOtpModal(){
  otpModal.classList.remove("show");
  otpModal.setAttribute("aria-hidden","true");
  stopOtpTimer();
  otpConfirmBtn.dataset.actionKey = "";
}

let otpInterval = null;
function startOtpTimer(actionKey){
  stopOtpTimer();
  const pending = pendingOTPs[actionKey];
  if (!pending){ otpTimerText.textContent = ""; return; }
  function tick(){
    const left = pending.expiresAt - Date.now();
    if (left <= 0){
      otpTimerText.textContent = "OTP expired. Request again.";
      clearInterval(otpInterval); otpInterval = null;
      delete pendingOTPs[actionKey];
      return;
    }
    const s = Math.ceil(left/1000);
    otpTimerText.textContent = `Expires in ${s} second${s>1?"s":""}`;
  }
  tick();
  otpInterval = setInterval(tick, 700);
}
function stopOtpTimer(){ if (otpInterval) { clearInterval(otpInterval); otpInterval = null; } otpTimerText.textContent = ""; }

/* ----------------------
   ACTION REQUEST (wrap)
   ---------------------- */
async function requestOtpForAction(actionType, id, payload, changedFields = [], oldData = null){
  const otp = genOtp();
  const actionKey = `${actionType}:${id}:${Date.now()}`;
  // prepare telegram text (use emojis format)
  let header = `üîî PAC Management ‚Äî ${actionType.toUpperCase()} Request\nUCL ID: <b>${escapeHtml(id)}</b>\n\n`;
  let body = "";
  if (actionType === "save"){
    body += `üÜï New Record Requested:\n- Name: ${escapeHtml(payload.name)}\n- IP: ${escapeHtml(payload.ip)}\n- Address: ${escapeHtml(payload.address)}\n\n`;
  } else if (actionType === "update") {
    body += `‚úèÔ∏è Fields Changed:\n`;
    changedFields.forEach(f=>{
      const oldV = oldData?.[f] ?? "";
      const newV = payload[f] ?? "";
      body += `‚Ä¢ ${f}: ${escapeHtml(String(oldV))} ‚Üí ${escapeHtml(String(newV))}\n`;
    });
    body += `\n`;
  } else if (actionType === "delete") {
    body += `‚ùó DELETE REQUEST\nName: ${escapeHtml(oldData?.name||"")}\nIP: ${escapeHtml(oldData?.ip||"")}\nAddress: ${escapeHtml(oldData?.address||"")}\n\n`;
  }
  const otpText = `OTP: <b>${otp}</b>\n(Valid 60 seconds)`;
  const text = header + body + otpText;

  pendingOTPs[actionKey] = {
    otp, expiresAt: Date.now() + OTP_TTL_MS, actionType, id, payload, changedFields, oldData
  };

  try {
    await sendToTelegram(text);
    openOtpModal(actionKey, actionType);
    showToast("OTP sent to Telegram");
  } catch (err) {
    delete pendingOTPs[actionKey];
    showToast("Failed to send OTP. Check token/chat id.", false);
  }
}

/* ----------------------
   CONFIRM OTP
   ---------------------- */
async function confirmOtpAndPerform(actionKey, enteredOtp){
  const pending = pendingOTPs[actionKey];
  if (!pending){ showToast("No pending OTP or expired", false); closeOtpModal(); return; }
  if (Date.now() > pending.expiresAt){ delete pendingOTPs[actionKey]; showToast("OTP expired", false); closeOtpModal(); return; }
  if (enteredOtp !== pending.otp){ showToast("Invalid OTP", false); return; }

  // perform
  const { actionType, id, payload, changedFields, oldData } = pending;
  try {
    if (actionType === "save" || actionType === "update"){
      const docRef = doc(db, "ucl_owners", id);
      // attach metadata: verifiedFields, lastVerifiedAt
      const verifiedFields = (actionType === "save") ? Object.keys(payload) : (changedFields.length ? changedFields : Object.keys(payload));
     await setDoc(docRef, {
  ...payload,
  verifiedFields,
  lastVerifiedAt: new Date().toISOString(),
  editedBy: "telegram-2fa",
  createdAt: payload.createdAt || Date.now()
}, { merge: true });


      // send success telegram message
      let successText = `‚úÖ ${actionType === "save" ? "CREATE SUCCESS" : "UPDATE SUCCESS"}\nUCL ID: <b>${escapeHtml(id)}</b>\n\nUpdated Fields:\n`;
      (verifiedFields).forEach(f => { successText += `‚Ä¢ ${f}\n`; });
      successText += `\nAt: ${new Date().toLocaleString()}`;
      await sendToTelegram(successText);

      showToast(actionType === "save" ? "Saved successfully" : "Updated successfully");
      clearForm();
    } else if (actionType === "delete"){
      // perform deletion after sending confirm
      await deleteDoc(doc(db, "ucl_owners", id));
      const successText = `üóëÔ∏è DELETE SUCCESS\nUCL ID: <b>${escapeHtml(id)}</b>\nDeleted at: ${new Date().toLocaleString()}`;
      await sendToTelegram(successText);
      showToast("Deleted successfully");
      if (editingId === id) clearForm();
    } else {
      showToast("Unknown action", false);
    }
  } catch (err){
    console.error("Action failed:", err);
    showToast("Action failed. Check console.", false);
  } finally {
    delete pendingOTPs[actionKey];
    closeOtpModal();
  }
}

/* ----------------------
   SAVE BUTTON -> triggers OTP (save or update)
   ---------------------- */
saveBtn.addEventListener("click", async ()=>{
  if (!validateForm()) return;
  const id = uclId.value.trim();
  const payload = {
    uclId: id,
    name: ownerName.value.trim(),
    ip: ipAddress.value.trim() || "Unavailable",
    address: address.value.trim()
  };

  // if editing: compare with existing doc to find changed fields
  if (editingId){
    const oldDocSnap = await getDoc(doc(db, "ucl_owners", editingId));
    const old = oldDocSnap.exists() ? oldDocSnap.data() : {};
    const changed = [];
    ["name","ip","address"].forEach(field=>{
      const oldV = String(old[field]||"").trim();
      const newV = String(payload[field]||"").trim();
      if (oldV !== newV) changed.push(field);
    });
    if (changed.length === 0){
      showToast("No changes detected", false);
      return;
    }
    await requestOtpForAction("update", id, payload, changed, old);
  } else {
    // create flow: still check if exists to avoid accidental overwrite
    try {
      const existing = await getDoc(doc(db, "ucl_owners", id));
      if (existing.exists()){
        // treat as update (user intends to overwrite) - show OTP with changed fields comparing
        const old = existing.data();
        const changed = [];
        ["name","ip","address"].forEach(field=>{
          const oldV = String(old[field]||"").trim();
          const newV = String(payload[field]||"").trim();
          if (oldV !== newV) changed.push(field);
        });
        await requestOtpForAction("update", id, payload, changed, old);
      } else {
        await requestOtpForAction(
  "save",
  id,
  { ...payload, createdAt: Date.now() },
  Object.keys(payload).concat(["createdAt"]),
  null
);
      }
    } catch (err){
      console.error(err);
      showToast("Error checking existing docs", false);
    }
  }
});

/* ----------------------
   DELETE -> request OTP
   ---------------------- */
async function requestDeleteWithOtp(id){
  try {
    const snap = await getDoc(doc(db, "ucl_owners", id));
    const data = snap.exists() ? snap.data() : null;
    await requestOtpForAction("delete", id, null, [], data);
  } catch (err){
    console.error(err);
    showToast("Delete request failed", false);
  }
}

/* ----------------------
   REALTIME LIST
   ---------------------- */
async function startRealtimeList() {
  const colRef = collection(db, "ucl_owners");

  if (unsubscribeSnapshot) unsubscribeSnapshot();

  unsubscribeSnapshot = onSnapshot(colRef, snapshot => {
    ownersCache = {};
    const rows = [];

    snapshot.forEach(docSnap => {
      const data = docSnap.data();

      // AUTO-FIX missing createdAt
      

      ownersCache[docSnap.id] = { ...data };
      rows.push({ id: docSnap.id, ...data });
    });

    // sort manually
    rows.sort((a, b) => {
  return (b.createdAt ?? 0) - (a.createdAt ?? 0);
});


    renderOwners(rows);
  }, err => {
    console.error("Snapshot error", err);
    showToast("Realtime list error", false);
  });
}


/* ----------------------
   RENDER TABLE
   ---------------------- */
function renderOwners(list){
  ownersTbody.innerHTML = "";
  const filter = (searchInput.value||"").trim().toLowerCase();
  const filtered = list.filter(item=>{
    if (!filter) return true;
    return (item.uclId||"").toLowerCase().includes(filter) ||
           (item.name||"").toLowerCase().includes(filter) ||
           (item.ip||"").toLowerCase().includes(filter);
  });
  totalCount.textContent = `(${filtered.length})`;
  if (filtered.length === 0){ emptyState.style.display = "block"; return; } else { emptyState.style.display = "none"; }
  filtered.forEach(row=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="font-weight:700">${escapeHtml(row.uclId||row.id)}</td>
      <td>${escapeHtml(row.name||"")}</td>
      <td>${escapeHtml(row.ip||"")}</td>
      <td style="text-align:right" class="row-actions">
        <button class="btn secondary btn-edit" data-id="${escapeHtml(row.uclId||row.id)}"><i class="fa-solid fa-pen-to-square"></i> Edit</button>
        <button class="btn secondary btn-delete" data-id="${escapeHtml(row.uclId||row.id)}"><i class="fa-solid fa-trash"></i> Delete</button>
      </td>
    `;
    ownersTbody.appendChild(tr);
  });

  Array.from(document.getElementsByClassName("btn-edit")).forEach(b=> b.onclick = ()=> startEdit(b.dataset.id) );
  Array.from(document.getElementsByClassName("btn-delete")).forEach(b=> b.onclick = ()=> requestDeleteWithOtp(b.dataset.id) );
}

/* ----------------------
   START EDIT
   ---------------------- */
function startEdit(id){
  const data = ownersCache[id];
  if (!data){ showToast("Record not found", false); return; }
  ownerName.value = data.name || "";
  uclId.value = id;
  uclId.disabled = true;
  ipAddress.value = data.ip || window.userIP || "";
  address.value = data.address || "";
  editingId = id;
  saveBtn.innerHTML = '<i class="fa-solid fa-pen-to-square"></i> Update';
  liveStatus.textContent = "Editing";
  liveStatus.className = "pill exists";
  window.scrollTo({ top: 0, behavior: "smooth" });
}

/* ----------------------
   SEARCH / REFRESH
   ---------------------- */
searchInput.addEventListener("input", ()=>{
  const rows = Object.keys(ownersCache).map(k=>({ uclId:k, ...ownersCache[k] }));

  // auto-trim unnecessary spaces
  searchInput.value = searchInput.value.trimStart();

  renderOwners(rows);
});


/* ----------------------
   OTP MODAL ACTIONS
   ---------------------- */
otpConfirmBtn.addEventListener("click", ()=>{
  const key = otpConfirmBtn.dataset.actionKey;
  const code = otpInput.value.trim();
  if (!key){ showToast("No action key", false); return; }
  if (!code){ showToast("Enter OTP", false); return; }
  confirmOtpAndPerform(key, code);
});
otpCancelBtn.addEventListener("click", ()=>{
  const key = otpConfirmBtn.dataset.actionKey;
  if (key && pendingOTPs[key]) delete pendingOTPs[key];
  closeOtpModal();
});

/* ----------------------
   CLEAR / KEYBOARD
   ---------------------- */
clearBtn.addEventListener("click", clearForm);
document.addEventListener("keydown", (e)=>{ if (e.ctrlKey && e.key === "Enter") saveBtn.click(); if (e.key === "Escape") clearBtn.click(); });

function loadNavMenuLive() {
  const menu = document.getElementById("mainMenu");
  if (!menu) return;

  const currentPage = window.location.pathname;  
  // Example: /addnav.html

  const q = query(collection(db, "pacnav"), orderBy("order"));

  onSnapshot(q, (snapshot) => {
    let html = "";

    snapshot.forEach((doc) => {
      const v = doc.data();

      // If this nav item‚Äôs URL matches the page URL ‚Üí SKIP
      if (v.url === currentPage) return;

      const iconClass =
        v.icon?.trim() ? v.icon : "fa-solid fa-circle-question";

      html += `
        <a href="${v.url}">
          <i class="${iconClass}"></i> ${v.title}
        </a>`;
    });

    menu.innerHTML = html;
  });
}

loadNavMenuLive();

/* ---------------- MOBILE MENU ---------------- */
window.toggleMenu = function () {
  const menu = document.getElementById("mainMenu");
  if (menu) menu.classList.toggle("show");
};
/* ----------------------
   INITIAL
   ---------------------- */
   startRealtimeList();
clearForm();
ownerName.focus();
console.warn("Telegram token and chat id are present in client code. Consider moving Telegram calls server-side for stronger security.");
</script>
</body>
</html>
