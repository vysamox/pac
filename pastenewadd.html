<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
<title>PAC Entry Form ‚Äî Advanced Auto Process</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />

<!-- üîç SEO Meta Tags -->
<meta name="description" content="PAC Entry Form with advanced auto processing, validation, UCL integration, and real-time PAC automation for CSC PAC users.">
<meta name="keywords" content="PAC Entry Form, PAC Auto Process, Advanced PAC, CSC PAC, PAC Automation, Digital PAC Entry">
<meta name="author" content="Samrat">

<!-- Google Search Essentials -->
<meta name="robots" content="index, follow" />
<meta name="googlebot" content="index, follow" />

<!-- Canonical URL -->
<link rel="canonical" href="https://cscpac.vercel.app/" />

<!-- üåê Open Graph -->
<meta property="og:title" content="PAC Entry Form ‚Äî Advanced Auto Process" />
<meta property="og:description" content="Advanced PAC auto process system for efficient PAC entry, tracking, and automation." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://cscpac.vercel.app/" />
<meta property="og:image" content="https://cscpac.vercel.app/assets/fav.png" />

<!-- üê¶ Twitter Card -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="PAC Entry Form ‚Äî Advanced Auto Process" />
<meta name="twitter:description" content="Fill PAC entries with auto-validation and smart automated PAC processing." />
<meta name="twitter:image" content="https://cscpac.vercel.app/assets/fav.png" />

<!-- ‚≠ê Favicon -->
<link rel="icon" type="image/png" href="assets/fav.png" />
<link rel="apple-touch-icon" href="assets/fav.png" />

<!-- üé® Styles & Fonts -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet" />



  <style>
    :root{
      --accent1:#007bff;
      --accent2:#00c6ff;
      --muted:#cfd8e3;
      --glass-bg: rgba(255,255,255,0.88);
      --card-shadow: 0 10px 25px rgba(0,0,0,0.08);
      --radius: 14px;
      --max-w: 960px;
    }

 /* ---------------- GLOBAL ---------------- */
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Poppins', sans-serif;
  background: #f4f7ff;
  color: #333;
  overflow-x: hidden;
}

/* ALWAYS hide toggle on desktop */
.menu-toggle {
  display: none !important;
}


/* ---------------- HEADER ---------------- */
header {
  background: rgba(0, 123, 255, 0.9);
  backdrop-filter: blur(10px);
  color: #fff;
  padding: 18px 40px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 1000;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

header h1 {
  font-size: 26px;
  display: flex;
  align-items: center;
  gap: 10px;
}

nav a {
  color: white;
  margin-left: 25px;
  font-weight: 600;
  text-decoration: none;
  position: relative;
  transition: 0.3s;
}

nav a:hover {
  color: #ffeb3b;
}

nav a::after {
  content: "";
  position: absolute;
  left: 0;
  bottom: -4px;
  width: 0%;
  height: 2px;
  background: #ffeb3b;
  transition: 0.3s;
}

nav a:hover::after {
  width: 100%;
}


    .page{
      max-width:var(--max-w);
      margin:36px auto;
      padding:0 18px 120px;
    }

    .form-container{
      background:var(--glass-bg);
      border-radius:16px;
      padding:24px;
      box-shadow:var(--card-shadow);
      border:1px solid rgba(255,255,255,0.6);
    }

    label{
      display:block;
      margin-top:12px;
      font-weight:700;
      color:#06438a;
      font-size:13px;
    }

    input[type="text"],
    textarea{
      width:100%;
      padding:11px;
      margin-top:6px;
      border-radius:10px;
      border:1.4px solid var(--muted);
      background:#fff;
      font-size:14px;
      transition:.15s;
    }

    input:focus,
    textarea:focus{
      outline:none;
      border-color:var(--accent1);
      box-shadow:0 8px 20px rgba(0,123,255,0.08);
      transform:translateY(-1px);
    }

    .owner-box{
      margin-top:18px;
      padding:14px;
      background:linear-gradient(135deg,#e9f5ff,#dff0ff);
      border-radius:10px;
      border:1px solid rgba(0,123,255,0.14);
      font-weight:700;
    }

    .dropdown-list{
      background:#fff;
      border:1px solid #d9e2ef;
      border-radius:10px;
      margin-top:6px;
      max-height:220px;
      overflow:auto;
      display:none;
      position:absolute;
      left:0; right:0;
      z-index:100;
      box-shadow:0 10px 22px rgba(0,0,0,0.1);
    }

    .dropdown-item{
      padding:10px;
      cursor:pointer;
      border-bottom:1px solid #f0f0f0;
      font-size:14px;
    }

    .dropdown-item:hover{
      background:#f1f6ff;
    }

   /* ===================== PREMIUM TABLE UI ===================== */

table {
  width: 100%;
  border-collapse: separate; /* better than collapse */
  border-spacing: 0;
  margin-top: 16px;
  display: none;
  background: #fff;
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 8px 20px rgba(0,0,0,0.08);
}

/* Header Styling */
th {
  background: linear-gradient(135deg, var(--accent1), var(--accent2));
  color: #fff;
  padding: 12px;
  font-size: 14px;
  font-weight: 700;
  text-transform: uppercase;
  border-bottom: 2px solid rgba(255,255,255,0.2);
}

th:first-child {
  border-top-left-radius: 14px;
}
th:last-child {
  border-top-right-radius: 14px;
}

/* Table Row Styling */
td {
  padding: 12px;
  border-bottom: 1px solid #eef2f9;
  font-size: 14px;
  text-align: center;
}

/* Zebra Effect */
tbody tr:nth-child(even) {
  background: #f9fbff;
}

/* Row Hover */
tbody tr:hover {
  background: #eef6ff !important;
  transition: 0.25s ease-in-out;
}

/* Purpose Tag */
.purpose-tag {
  background: #e8f1ff;
  color: #0054c7;
  padding: 4px 10px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  display: inline-block;
}

/* Amount Tag */
.amount-tag {
  background: #eaffea;
  color: #0a8a28;
  padding: 4px 10px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 700;
  display: inline-block;
}

/* Status Tags */
.status-new {
  background: #e9ffef;
  color: #0a8a28;
  font-weight: 700;
  padding: 6px 12px;
  border-radius: 10px;
  display: inline-block;
}

.status-exists {
  background: #ffe6e6;
  color: #d10000;
  font-weight: 700;
  padding: 6px 12px;
  border-radius: 10px;
  display: inline-block;
}


    .btn{
      padding:12px 16px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-weight:700;
      background:linear-gradient(135deg,var(--accent1),var(--accent2));
      color:white;
    }

    .btn.secondary{
      background:#fff;
      color:var(--accent1);
      border:1px solid #d9e2ef;
    }

    footer{
      background:var(--accent1);
      padding:12px;
      color:white;
      text-align:center;
      font-size:14px;
      position:fixed;
      bottom:0;
      left:0;
      width:100%;
    }

    /* ---------------- MOBILE HEADER (FINAL FIXED VERSION) ---------------- */
@media (max-width: 768px) {

  header {
    padding: 12px 18px;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    height: 60px;
  }

  header h1 {
    font-size: 18px;
    gap: 8px;
    margin: 0;
    white-space: nowrap;
  }

  header h1 i {
    font-size: 18px;
  }

  .menu-toggle {
    display: block !important;
    font-size: 24px;
    cursor: pointer;
    color: #fff;
  }

  /* Mobile nav dropdown */
  header nav {
    position: absolute;
    top: 60px;
    left: 0;
    width: 100%;
    background: rgba(0,123,255,0.95);
    max-height: 0;
    overflow: hidden;
    flex-direction: column;
    transition: max-height 0.35s ease;
    border-bottom-left-radius: 20px;
    border-bottom-right-radius: 20px;
    padding: 0;
  }

  header nav.show {
    max-height: 450px;
  }

  header nav a {
    padding: 14px 22px;
    margin: 0;
    display: block;
    font-size: 15px;
  }

}

.app-footer {
  background: linear-gradient(90deg, #004aad, #007bff);
  color: #fff;
  text-align: center;
  padding: 18px 12px;
  font-size: 13px;
}

.app-footer .footer-line {
  margin-top: 6px;
  opacity: 0.95;
}

.dashboard-version {
  margin-top: 8px;
  display: inline-block;
  padding: 6px 12px;
  border-radius: 999px;
  font-size: 13px;
  font-weight: 600;
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(5px);
  white-space: nowrap;
}

@media (max-width: 600px) {
  .dashboard-version {
    white-space: normal;
    line-height: 1.4;
  }
}

  </style>

</head>
<body>

<header>
   <h1><i class="fa-solid fa-database"></i> PAC Management</h1>
   <!-- Mobile Menu Toggle -->
  <div class="menu-toggle" onclick="toggleMenu()">
    <i class="fa-solid fa-bars"></i>
  </div>
 <nav id="mainMenu">
  </nav>
</header>

<div class="page">
  <div class="form-container">

    <h2>PAC Entry Form</h2>

    <!-- Dropdown -->
    <label>Select UCL Owner</label>
    <div style="position:relative">
      <input type="text" id="searchBox" placeholder="Search UCL ID / Name / IP">
      <div id="dropdownList" class="dropdown-list"></div>
    </div>

    <!-- Owner Preview -->
    <div id="ownerBox" class="owner-box">Loading owner info...</div>

    <!-- Paste Area -->
    <h3 style="margin-top:18px">Paste All Details</h3>
    <textarea id="pasteData" rows="8" placeholder="Paste CSC REF details here..."></textarea>

    <!-- Progress -->
    <div id="progressContainer" style="display:none; margin-top:10px;">
      <div id="progressBar" style="height:10px; width:0%; background:linear-gradient(90deg,#007bff,#00c6ff); border-radius:10px;"></div>
      <p id="progressText" style="font-weight:600; margin-top:6px; text-align:center;">Checking‚Ä¶</p>
    </div>

    <!-- Table -->
    <table id="dataTable">
      <thead>
        <tr>
          <th>UCL ID</th>
          <th>CSC REF</th>
          <th>PAC Number</th>
          <th>ORDERED ON</th>
          <th>Purpose</th>
          <th>Total Amount</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Save -->
    <button id="saveAllBtn" class="btn" style="display:none; margin-top:16px;">üíæ Save </button>

  </div>
</div>

<footer class="app-footer">
  <div class="footer-line">
    ¬© 2025 PAC Management System ‚Äî Auto Process Enabled
  </div>

  <div class="dashboard-version">
    Loading dashboard version‚Ä¶
  </div>

  <div class="footer-line">
    <span id="footer-ip">IP: Loading‚Ä¶</span>
  </div>
</footer>

<!-- üîê TEMP ACCESS SYSTEM -->
<script src="assets/js/temp-url.js"></script>

<!-- Firebase -->
<script type="module">

/*  FIREBASE INIT  */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, collection, getDocs, onSnapshot, query, orderBy, updateDoc
} from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

/* üîë expose Firebase v9 helpers for temp-url.js */
window.__FIREBASE_V9__ = {
  doc,
  getDoc,
  setDoc,
  updateDoc,
};


const firebaseConfig = {
  apiKey: "AIzaSyCE2_x5xvW3wCsOx6jo9-ZhNOhgWm86cPY",
  authDomain: "mrsamrat08.firebaseapp.com",
  projectId: "mrsamrat08",
  storageBucket: "mrsamrat08.appspot.com",
  messagingSenderId: "525481767881",
  appId: "1:525481767881:web:6fd53162b242709890ae18"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// üîê TEMP ACCESS CHECK (REQUIRED)
secureTempAccess(db);

/* ELEMENTS */
const searchBox = document.getElementById("searchBox");
const dropdownList = document.getElementById("dropdownList");
const ownerBox = document.getElementById("ownerBox");
const footerIp = document.getElementById("footer-ip");

const pasteData = document.getElementById("pasteData");
const dataTable = document.getElementById("dataTable");
const tbody = dataTable.querySelector("tbody");

const progressContainer = document.getElementById("progressContainer");
const progressBar = document.getElementById("progressBar");
const progressText = document.getElementById("progressText");

const saveAllBtn = document.getElementById("saveAllBtn");

let owners = [];
let pastedRefs = new Set();
let currentUserIP = null;   // ‚Üê store current detected IP


/* ESCAPE HTML */
function escapeHtml(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;"); }

/* LOAD OWNERS */
async function loadOwners(){
  const q = collection(db,"ucl_owners");
  const snap = await getDocs(q);

  owners = [];

  snap.forEach(docSnap=>{
    const d = docSnap.data();
    owners.push({
      uclId: d.uclId || docSnap.id,
      name: d.name || "",
      ip: d.ip || "",
      address: d.address || "",
      lastVerifiedAt: d.lastVerifiedAt || ""
    });
  });

 renderDropdown(owners);

setTimeout(() => {
  autoDetectIP();
}, 500);   // wait for owners list to fully populate

}

/* RENDER DROPDOWN */
function renderDropdown(list){
  dropdownList.innerHTML = "";

  list.forEach(o=>{
    const d = document.createElement("div");
    d.className = "dropdown-item";
    d.innerHTML = `<b>${o.uclId}</b> ‚Äî ${o.name} ‚Ä¢ ${o.ip}`;
    d.onclick = ()=>{
      selectOwner(o);
      dropdownList.style.display = "none";
      searchBox.value = o.uclId + " ‚Äî " + o.name;
    };
    dropdownList.appendChild(d);
  });
}

/* SEARCH FILTER */
searchBox.addEventListener("input",()=>{
  dropdownList.style.display = "block";
  const q = searchBox.value.toLowerCase();
  renderDropdown(owners.filter(o =>
    o.uclId.toLowerCase().includes(q) ||
    o.name.toLowerCase().includes(q) ||
    o.ip.toLowerCase().includes(q)
  ));
});

/* SELECT OWNER */
let currentOwner = null;

function selectOwner(o){
  currentOwner = o;

  const uclIP = o.ip || "Unknown";
  const myIP = currentUserIP || "Detecting...";

  let ipStatus = "";

  if (currentUserIP === null) {
    ipStatus = `<b>IP Check:</b> üîÑ Detecting your IP...`;
  } 
  else if (uclIP === myIP) {
    ipStatus = `<b>IP Check:</b> <span style="color:#0a8a28;font-weight:600;">‚úî MATCHED ‚Äî You can add PAC</span>`;
  } 
  else {
    ipStatus = `<b>IP Check:</b> <span style="color:#d10000;font-weight:600;">‚úñ MISMATCH ‚Äî PAC saving will be blocked</span>`;
  }

  ownerBox.innerHTML = `
    <b>üÜî UCL:</b> ${o.uclId}<br>
    <b>üë§ Name:</b> ${o.name}<br>
    <b>üåê UCL IP:</b> ${uclIP}<br>
    <b>üßë‚Äçüíª Your IP:</b> ${myIP}<br>
    <b>üìç Address:</b> ${o.address}<br>
    <b>üîé Last Verify:</b> ${o.lastVerifiedAt}<br>
    <div style="text-align:center; margin-top:8px;">
  ${ipStatus}
</div>

  `;
}

/* AUTO DETECT USER IP & MATCH OWNER */
async function autoDetectIP(){
  let ip = null;
  try{
    const r = await fetch("https://api.ipify.org?format=json");
    ip = (await r.json()).ip;
  }catch(e){}
  
  footerIp.textContent = "IP: " + (ip || "Unavailable");
currentUserIP = ip;   // ‚Üê SAVE CURRENT IP


  if(!ip) return;

  const found = owners.find(o => o.ip === ip);
  if(found){
    selectOwner(found);
    searchBox.value = found.uclId + " ‚Äî " + found.name;
  }
}

/* AUTO-PROCESS PASTE (Option 2 with debounce) */
let pasteTimer = null;

pasteData.addEventListener("paste", ()=>{
  if(pasteTimer) clearTimeout(pasteTimer);
  pasteTimer = setTimeout(()=>processPastedData(), 400);
});

/* PROCESS PASTED DATA */
async function processPastedData(){

if (!currentOwner) {
  alert("‚ö†Ô∏è Please select a UCL owner first!");
  return;
}

  const text = pasteData.value.trim();
  if(!text) return;

  // IMPROVED REGEX
  const refRegex = /CSC\s*REF[:\s]*([0-9]+)/gi;
  const orderRegex = /ORDERED\s*ON\s*[\r\n]+([^\r\n]+)/gi;
  const amountRegex = /Total\s*Amount[:\s]*‚Çπ?\s*([0-9,\.]+)/gi;
  // UNIVERSAL PURPOSE EXTRACTOR
const purposeRegex = /WALLET\s*DEDUCTION[\s\S]*?Success([\s\S]*?)ORDER\s*TOTAL/gi;

const purposes = [...text.matchAll(purposeRegex)]
  .map(x => x[1].trim().replace(/\n+/g, " / ").replace(/\s+/g, " "));

  const refs = [...text.matchAll(refRegex)].map(x=>x[1]);
  const dates = [...text.matchAll(orderRegex)].map(x=>x[1].trim());
  const amounts = [...text.matchAll(amountRegex)].map(x=>x[1]);

  if(refs.length===0){
    alert("‚ùå No CSC REF found!");
    return;
  }

  tbody.innerHTML = "";
  pastedRefs.clear();

  progressContainer.style.display = "block";
  progressBar.style.width = "0%";
  dataTable.style.display = "none";

  for(let i=0;i<refs.length;i++){

    const ref = refs[i];
    const pacNo = ref.slice(-8);
    const date = toISODate(dates[i] || "");
    const amt = amounts[i] || "";

    let status = "";
    let bg = "";

    const docRef = doc(db,"pac_entries",pacNo);
    const snap = await getDoc(docRef);

 if (snap.exists()) {
  const oldUCL = snap.data().uclNo || "Unknown";

  status = `
    <span style="color:#d10000;font-weight:600;">
      ‚ö†Ô∏è Already Exists
    </span><br>
    <span style="font-size:12px; color:#444;">
      Saved by: <b>${oldUCL}</b>
    </span>
  `;

  bg = "#ffe6e6";
} else {
  status = `
    <span style="color:#009900;font-weight:600;">
      ‚úÖ New Entry
    </span>
  `;
  bg = "#e9ffef";
}


const tr = document.createElement("tr");
tr.dataset.exists = snap.exists() ? "1" : "0";

tr.style.background = bg;
tr.innerHTML = `
  <td>${escapeHtml(currentOwner?.uclId || "UNKNOWN")}</td>
  <td>${ref}</td>
  <td>${pacNo}</td>
  <td>${date}</td>
  <td><span class="purpose-tag">${escapeHtml(purposes[i] || "Unknown")}</span></td>
  <td><span class="amount-tag">‚Çπ${amt}</span></td>
  <td>${status}</td>
`;
tbody.appendChild(tr);


    const percent = Math.round(((i+1)/refs.length)*100);
    progressBar.style.width = percent + "%";

    await new Promise(r=>setTimeout(r,40));
  }

  progressContainer.style.display = "none";
  dataTable.style.display = "table";
  saveAllBtn.style.display = "inline-block";
}

/* SAVE ALL */
saveAllBtn.onclick = async ()=>{

  // üö® SECURITY CHECK ‚Äî BLOCK SAVE IF IP DOES NOT MATCH OWNER IP
  if (currentOwner?.ip !== currentUserIP) {
    alert("‚ùå SECURITY BLOCKED!\n\nYour current IP does not match the selected UCL Owner's IP.\n\nPAC saving is stopped.");
    return;
  }


  const rows = [...tbody.querySelectorAll("tr")];
  let saved = 0;

  for(const row of rows){
  // SKIP EXISTING PAC ENTRIES
if (row.dataset.exists === "1") continue;

    const t = row.children;

    const uclId = t[0].innerText.trim();
    const ref = t[1].innerText.trim();
    const pac = t[2].innerText.trim();
    const date = t[3].innerText.trim();
     const purpose = t[4].innerText.trim();
const amt = t[5].innerText.replace("‚Çπ", "").trim().replace(/,/g, "");



    const docRef = doc(db,"pac_entries",pac);

await setDoc(docRef,{
  pacNo: pac,
  cscRef: ref,
  uclNo: uclId,
  uclOwnerName: currentOwner?.name || "",
  uclOwnerIp: currentOwner?.ip || "",       // ‚≠ê owner IP stored
  savedFromIp: currentUserIP || "Unknown",  // ‚≠ê real-time user IP saved
  orderDate: date,
  purpose: purpose,
  amount: amt,
  entryDate: new Date().toISOString().split("T")[0],
  entryTime: new Date().toLocaleTimeString(),
  uploadType: "Pasted"
});

    saved++;
  }

  alert("Saved Successfully: " + saved);
};

function toISODate(dateStr) {
  const months = {
    jan:"01", feb:"02", mar:"03", apr:"04", may:"05", jun:"06",
    jul:"07", aug:"08", sep:"09", oct:"10", nov:"11", dec:"12"
  };

  const parts = dateStr.trim().split(" ");
  if (parts.length < 3) return dateStr;

  const day = parts[0].padStart(2,"0");
  const mon = months[parts[1].substring(0,3).toLowerCase()] || "";
  const year = parts[2];

  if (!mon) return dateStr;  
  return `${year}-${mon}-${day}`;
}

/* ----------------------------------------------------
   REAL-TIME LIVE NAVIGATION UPDATE (NO REFRESH NEEDED)
----------------------------------------------------- */
function loadNavMenuLive() {
  const menu = document.getElementById("mainMenu");
  if (!menu) return;

  // Get current filename only
  const currentPage = window.location.pathname.split("/").pop();

  const q = query(
    collection(db, "pacnav"),
    orderBy("order", "asc")
  );

  onSnapshot(q, (snapshot) => {
    let html = "";

    snapshot.forEach((docSnap) => {
      const v = docSnap.data();

      // ‚ùå Skip inactive
      if (v.active === false) return;

      // ‚ùå Skip current page
      const navUrl = (v.url || "").split("/").pop();
      if (navUrl === currentPage) return;

      const iconClass =
        v.icon && v.icon.trim()
          ? v.icon
          : "fa-solid fa-circle-question";

      html += `
        <a href="${v.url}">
          <i class="${iconClass}"></i> ${v.title || ""}
        </a>
      `;
    });

    menu.innerHTML = html;
  });
}

loadNavMenuLive();


/* ---------------- MOBILE MENU ---------------- */
window.toggleMenu = function () {
  const menu = document.getElementById("mainMenu");
  if (menu) menu.classList.toggle("show");
};

loadOwners();
</script>
<script type="module">
  import { loadDashboardVersion } from "./assets/js/dashboard-version.js";
  loadDashboardVersion();
</script>

</body>
</html>
