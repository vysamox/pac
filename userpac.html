<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User PAC Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Poppins', sans-serif; background:#f4f7ff; color:#333; overflow-x:hidden; }

.menu-toggle { display:none !important; }

header{
  background:rgba(0,123,255,0.9); backdrop-filter:blur(10px);
  color:#fff; padding:18px 40px; display:flex; justify-content:space-between;
  align-items:center; position:sticky; top:0; z-index:1000;
  box-shadow:0 4px 20px rgba(0,0,0,0.3);
}
header h1 { font-size:26px; display:flex; gap:10px; }

nav a{
  color:white; margin-left:25px; font-weight:600; text-decoration:none;
  position:relative; transition:0.3s;
}
nav a:hover{ color:#ffeb3b; }
nav a::after{
  content:""; position:absolute; left:0; bottom:-4px;
  width:0%; height:2px; background:#ffeb3b; transition:0.3s;
}
nav a:hover::after{ width:100%; }

.select-box{
  width:95%; margin:15px auto; padding:15px; background:white;
  border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.12);
}
.select-box select{
  width:100%; padding:10px; font-size:16px; border-radius:8px; border:1px solid #ccc;
}

.user-box{
  width:95%; margin:15px auto; padding:15px; background:white;
  border-radius:10px; display:none; box-shadow:0 4px 10px rgba(0,0,0,0.15);
}

.table-container{ width:100%; overflow-x:auto; display:none; }

table{
  width:95%; margin:20px auto; background:white;
  border-collapse:collapse; border-radius:10px;
  box-shadow:0 5px 15px rgba(0,0,0,0.15);
}
thead{ background:#007bff; color:white; }
th,td{ padding:12px; border:1px solid #d0d7de; }

.nodata{ text-align:center; font-size:17px; padding:15px; }

@media(max-width:768px){
  header{ padding:12px 18px; height:60px; }
  header h1{ font-size:18px; }
  .menu-toggle{ display:block !important; font-size:24px; color:#fff; }
  header nav{
    position:absolute; top:60px; left:0; width:100%;
    background:rgba(0,123,255,0.95); max-height:0;
    overflow:hidden; flex-direction:column; transition:max-height 0.35s;
    border-bottom-left-radius:20px; border-bottom-right-radius:20px;
  }
  header nav.show{ max-height:500px; }
  header nav a{ padding:14px 22px; margin:0; display:block; }
}
</style>
</head>

<body>

<header>
  <h1><i class="fa-solid fa-database"></i> PAC Management</h1>
  <div class="menu-toggle" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></div>
  <nav id="mainMenu"></nav>
</header>

<div class="select-box">
  <label><b>Select User</b></label>
  <select id="userSelect" onchange="manualSelectUser()">
    <option value="">Loading users...</option>
  </select>
</div>

<div class="user-box" id="userBox"></div>

<div class="table-container" id="tableBox">
  <table>
    <thead>
      <tr>
        <th>PAC Code</th>
        <th>CSC Ref</th>
        <th>Amount</th>
        <th>Order Date</th>
        <th>Entry Date</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="pacBody">
      <tr><td colspan="6" class="nodata">Select a user</td></tr>
    </tbody>
  </table>

  <div id="paginationControls" style="display:none;text-align:center;margin-bottom:20px;">
    <button onclick="prevPage()" id="prevBtn" style="padding:8px 15px;margin-right:10px;">Prev</button>
    <button onclick="nextPage()" id="nextBtn" style="padding:8px 15px;">Next</button>
  </div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCE2_x5xvW3wCsOx6jo9-ZhNOhgWm86cPY",
  authDomain: "mrsamrat08.firebaseapp.com",
  projectId: "mrsamrat08",
  storageBucket: "mrsamrat08.firebasestorage.app",
  messagingSenderId: "525481767881",
  appId: "1:525481767881:web:6fd53162b242709890ae18"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let allUsers = [], userIP = "", selectedUser = null;

// Load IP
async function getIP() {
  const ip = await fetch("https://api.ipify.org?format=json").then(r=>r.json());
  userIP = ip.ip;
  loadUsers();
}

// Load Users
function loadUsers() {
  db.collection("ucl_owners").onSnapshot(snap=>{
    allUsers = snap.docs.map(d=>({id:d.id, ...d.data()}));
    fillUserDropdown();
    autoSelectIPUser();
  });
}

function fillUserDropdown() {
  const sel = document.getElementById("userSelect");
  sel.innerHTML = `<option value="">-- Select User --</option>`;
  allUsers.forEach(u => {
    sel.innerHTML += `<option value="${u.ip}">${u.name} (${u.uclId})</option>`;
  });
}

function autoSelectIPUser() {
  const user = allUsers.find(u=>u.ip===userIP);
  if (user) {
    document.getElementById("userSelect").value = user.ip;
    showUserDetails(user);
  }
}

function manualSelectUser() {
  const ip = document.getElementById("userSelect").value;
  showUserDetails(allUsers.find(u=>u.ip===ip));
}

function showUserDetails(user) {
  if (!user) return;
  selectedUser = user;

  document.getElementById("userBox").style.display = "block";
  document.getElementById("userBox").innerHTML = `
    <h2>${user.name} (${user.uclId})</h2>
    <div><b>Address:</b> ${user.address || "-"}</div>
    <div><b>IP:</b> ${user.ip}</div>
  `;

  document.getElementById("tableBox").style.display = "block";
  resetPagination();
  loadPACs(user.uclId);
}

/* ---------- PAGINATION ---------- */
let pageLimit = 5;
let lastVisible = null;
let firstVisible = null;
let paginationStack = [];

function resetPagination() {
  lastVisible = null;
  firstVisible = null;
  paginationStack = [];
}

function loadPACs(uclId, isNext = true) {
  const tbody = document.getElementById("pacBody");
  tbody.innerHTML = `<tr><td colspan="6" class="nodata">Loading...</td></tr>`;

  let query = db.collection("pac_entries")
                .where("uclNo", "==", uclId)
                .orderBy("entryDate", "desc")
                .limit(pageLimit);

  if (isNext && lastVisible) query = query.startAfter(lastVisible);
  if (!isNext && firstVisible) query = query.endBefore(firstVisible);

  query.get().then(snap=>{
    tbody.innerHTML = "";

    if (snap.empty) {
      tbody.innerHTML = `<tr><td colspan="6" class="nodata">No PAC found</td></tr>`;
      return;
    }

    firstVisible = snap.docs[0];
    lastVisible = snap.docs[snap.docs.length-1];
    if (isNext) paginationStack.push(firstVisible);

    snap.forEach(doc=>{
      const d = doc.data();
      tbody.innerHTML += `
        <tr>
          <td>${doc.id}</td>
          <td>${d.cscRef || "-"}</td>
          <td>${d.amount || "-"}</td>
          <td>${d.orderDate || "-"}</td>
          <td>${d.entryDate || "-"}</td>
          <td>
            <button onclick="copyPAC('${doc.id}')">Copy</button>
            <button onclick="deletePAC('${doc.id}')">Delete</button>
          </td>
        </tr>
      `;
    });

    document.getElementById("paginationControls").style.display = "block";
    document.getElementById("prevBtn").disabled = (paginationStack.length <= 1);
  });
}

function nextPage() {
  if (lastVisible) loadPACs(selectedUser.uclId, true);
}

function prevPage() {
  if (paginationStack.length > 1) {
    paginationStack.pop();
    firstVisible = paginationStack[paginationStack.length-1];
    loadPACs(selectedUser.uclId, false);
  }
}

/* ---------- ACTION BUTTONS ---------- */
function copyPAC(id) {
  navigator.clipboard.writeText(id);
  alert("PAC Code Copied: " + id);
}

function deletePAC(id) {
  if (!confirm("Delete this PAC entry?")) return;
  db.collection("pac_entries").doc(id).delete().then(()=>{
    alert("PAC deleted successfully.");
    resetPagination();
    loadPACs(selectedUser.uclId);
  });
}

/* NAV MENU */
function loadNavMenuLive() {
  const menu = document.getElementById("mainMenu");
  const currentPage = window.location.pathname;

  db.collection("pacnav").orderBy("order").onSnapshot(snap=>{
    let html = "";
    snap.forEach(doc=>{
      const v = doc.data();
      if (v.url === currentPage) return;
      html += `<a href="${v.url}"><i class="${v.icon || 'fa-solid fa-circle-question'}"></i> ${v.title}</a>`;
    });
    menu.innerHTML = html;
  });
}
loadNavMenuLive();

function toggleMenu() {
  document.getElementById("mainMenu").classList.toggle("show");
}

getIP();
</script>

</body>
</html>
