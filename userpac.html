<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PAC Management â€“ Glass Dashboard</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
/* ---------------- GLOBAL ---------------- */
* { margin:0; padding:0; box-sizing:border-box; }

body {
    font-family:'Poppins', sans-serif;
    background: linear-gradient(135deg, #dbe8ff, #f0f6ff, #d7ecff);
    min-height:100vh;
    padding-bottom:40px;
}

/* ---------------- GLASS HEADER ---------------- */
header{
    position:sticky;
    top:0;
    z-index:999;
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:18px 40px;

    background:rgba(255,255,255,0.25);
    backdrop-filter:blur(18px);
    border-bottom:1px solid rgba(255,255,255,0.25);
    box-shadow:0 8px 25px rgba(0,0,0,0.12);

    border-radius:0 0 25px 25px;
}

header h1{
    display:flex;
    align-items:center;
    font-size:26px;
    color:#003f8c;
    gap:12px;
    font-weight:700;
}

header h1 i{
    font-size:28px;
    color:#006eff;
}

/* ---------------- NAV ---------------- */
nav a{
    text-decoration:none;
    font-size:16px;
    margin-left:22px;
    padding:10px 14px;

    color:#004aad;
    font-weight:600;

    border-radius:10px;
    transition:0.3s;
}

nav a:hover{
    background:rgba(255,255,255,0.4);
    color:#002f72;
    backdrop-filter: blur(6px);
}

.menu-toggle { display:none; }

/* ---------------- GLASS CARD ---------------- */
.glass-card{
    width:95%;
    margin:20px auto;
    padding:20px;

    background:rgba(255,255,255,0.55);
    border-radius:18px;
    backdrop-filter:blur(15px);
    border:1px solid rgba(255,255,255,0.35);

    box-shadow:0 10px 40px rgba(0,0,0,0.12);
}

/* SELECT BOX */
.glass-card select{
    width:100%;
    padding:14px;
    font-size:16px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,0.08);
    background:rgba(255,255,255,0.7);
    backdrop-filter:blur(4px);
}

/* USER BOX */
#userBox h2{
    font-size:22px;
    margin-bottom:8px;
    color:#003f8c;
}

/* ---------------- TABLE ---------------- */
.table-container{
    width:95%;
    margin:20px auto;
    display:none;
}

table{
    width:100%;
    border-collapse:collapse;

    overflow:hidden;
    border-radius:15px;
    background:rgba(255,255,255,0.55);
    backdrop-filter:blur(15px);
    border:1px solid rgba(255,255,255,0.3);

    box-shadow:0 10px 40px rgba(0,0,0,0.12);
}

thead{
    background:rgba(0,80,255,0.75);
    color:white;
}

th,td{
    padding:14px;
    font-size:15px;
    border-bottom:1px solid rgba(255,255,255,0.2);
}

tbody tr:hover{
    background:rgba(255,255,255,0.45);
    backdrop-filter:blur(10px);
    transition:0.25s;
}

.nodata{
    text-align:center;
    padding:15px;
    font-size:16px;
}

/* ---------------- BUTTONS ---------------- */
.table-btn{
    padding:7px 14px;
    border:none;
    border-radius:10px;
    font-size:14px;
    font-weight:600;
    cursor:pointer;
    transition:0.25s;
    color:white;
}

/* Copy */
.btn-copy { background:#007bff; }
.btn-copy:hover { background:#0056b3; }

/* Delete */
.btn-delete { background:#d93030; }
.btn-delete:hover { background:#b01f1f; }

/* Pagination */
.pg-btn{
    background:#6c63ff;
    padding:10px 22px;
    border:none;
    border-radius:12px;
    font-size:15px;
    font-weight:600;
    color:white;
    transition:0.3s;
}

.pg-btn:hover{
    background:#4e45f5;
    transform:translateY(-2px);
}

.pg-btn:disabled{
    background:#b8b8b8;
}

/* ---------------- MOBILE ---------------- */
@media(max-width:768px){

    header{
        padding:14px 20px;
    }

    header h1{
        font-size:18px;
    }
    header h1 i{ font-size:20px; }

    .menu-toggle{
        display:block;
        font-size:24px;
        color:#003f8c;
        cursor:pointer;
    }

    nav{
        position:absolute;
        top:72px;
        left:0;
        width:100%;
        background:rgba(255,255,255,0.50);
        backdrop-filter:blur(15px);
        max-height:0;
        overflow:hidden;
        transition:0.35s ease;
        border-radius:0 0 18px 18px;
        box-shadow:0 8px 25px rgba(0,0,0,0.15);
    }

    nav.show{
        max-height:450px;
    }

    nav a{
        display:block;
        padding:15px 22px;
        margin:0;
    }
}
</style>
</head>

<body>

<!-- ================= HEADER ================= -->
<header>
  <h1><i class="fa-solid fa-database"></i> PAC Management</h1>
  <div class="menu-toggle" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></div>
  <nav id="mainMenu"></nav>
</header>

<!-- ================= USER SELECT ================= -->
<div class="glass-card">
  <label><b>Select User</b></label>
  <select id="userSelect" onchange="manualSelectUser()">
    <option value="">Loading users...</option>
  </select>
</div>

<!-- ================= USER DETAILS ================= -->
<div class="glass-card" id="userBox" style="display:none;"></div>

<!-- ================= TABLE ================= -->
<div class="table-container" id="tableBox">
  <table>
    <thead>
      <tr>
        <th>PAC Code</th>
        <th>CSC Ref</th>
        <th>Amount</th>
        <th>Order Date</th>
        <th>Entry Date</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="pacBody">
      <tr><td colspan="6" class="nodata">Select a user</td></tr>
    </tbody>
  </table>

  <div id="paginationControls" style="text-align:center;margin-top:18px;display:none;">
    <button class="pg-btn" onclick="prevPage()" id="prevBtn">Prev</button>
    <button class="pg-btn" onclick="nextPage()" id="nextBtn" style="margin-left:8px;">Next</button>
  </div>
</div>


<!-- ================= FIREBASE ================= -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
/* === Firebase Config === */
const firebaseConfig = {
  apiKey: "AIzaSyCE2_x5xvW3wCsOx6jo9-ZhNOhgWm86cPY",
  authDomain: "mrsamrat08.firebaseapp.com",
  projectId: "mrsamrat08",
  storageBucket: "mrsamrat08.firebasestorage.app",
  messagingSenderId: "525481767881",
  appId: "1:525481767881:web:6fd53162b242709890ae18"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let allUsers = [];
let userIP = "";
let selectedUser = null;

let pageLimit = 5;
let lastVisible = null;
let firstVisible = null;
let paginationStack = [];
let pages = [];
let currentPage = 0;


/* ---------------- LOAD IP ---------------- */
async function getIP(){
  try{
    const res = await fetch("https://api.ipify.org?format=json");
    const data = await res.json();
    userIP = data.ip;
  }catch{
    userIP = "";
  }
  loadUsers();
}

/* ---------------- LOAD USERS ---------------- */
function loadUsers(){
  db.collection("ucl_owners").onSnapshot(snap=>{
    allUsers = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    fillUserDropdown();
    autoSelectIPUser();
  });
}
function fillUserDropdown(){
  const sel = document.getElementById("userSelect");
  sel.innerHTML = `<option value="">-- Select User --</option>`;
  allUsers.forEach(u=>{
    sel.innerHTML += `<option value="${u.ip}">${u.name} (${u.uclId})</option>`;
  });
}
function autoSelectIPUser(){
  const user = allUsers.find(u=>u.ip === userIP);
  if(user){
    document.getElementById("userSelect").value = user.ip;
    showUserDetails(user);
  }
}
function manualSelectUser(){
  const ip = document.getElementById("userSelect").value;
  const user = allUsers.find(u=>u.ip === ip);
  showUserDetails(user);
}

/* ---------------- SHOW USER ---------------- */
function showUserDetails(user){
  selectedUser = user;
  const box = document.getElementById("userBox");
  box.style.display = "block";

  box.innerHTML = `
    <h2>${user.name} (${user.uclId})</h2>
    <div><b>Address:</b> ${user.address || "-"}</div>
    <div><b>IP:</b> ${user.ip}</div>
  `;

  document.getElementById("tableBox").style.display = "block";
  resetPagination();
  loadPACs(user.uclId, true);
}

/* ---------------- PAGINATION RESET ---------------- */
function resetPagination(){
  lastVisible = null;
  firstVisible = null;
  paginationStack = [];
}

/* ---------------- LOAD PAC LIST ---------------- */
function loadPACs(uclId, goNext = true) {
    const tbody = document.getElementById("pacBody");
    tbody.innerHTML = `<tr><td colspan="6" class="nodata">Loading...</td></tr>`;

    let query = db.collection("pac_entries")
        .where("uclNo", "==", uclId)
        .orderBy("entryDate", "desc")
        .limit(pageLimit);

    // NEXT PAGE
    if (goNext && pages[currentPage]) {
        query = query.startAfter(pages[currentPage].last);
    }

    // PREV PAGE
    if (!goNext && currentPage > 0) {
        query = query.startAt(pages[currentPage - 1].first);
    }

    query.get().then(snap => {
        tbody.innerHTML = "";

        if (snap.empty) {
            tbody.innerHTML = `<tr><td colspan="6" class="nodata">No PAC found</td></tr>`;
            return;
        }

        let first = snap.docs[0];
        let last = snap.docs[snap.docs.length - 1];

        // Save page snapshot
        if (goNext) {
            pages[currentPage + 1] = { first, last };
            currentPage++;
        } else {
            currentPage--;
        }

        snap.forEach(doc => {
            const d = doc.data();
            tbody.innerHTML += `
                <tr>
                    <td>${doc.id}</td>
                    <td>${d.cscRef || "-"}</td>
                    <td>${d.amount || "-"}</td>
                    <td>${d.orderDate || "-"}</td>
                    <td>${d.entryDate || "-"}</td>
                    <td>
                        <button class="table-btn btn-copy" onclick="copyPAC('${doc.id}')">
                            <i class="fa-solid fa-copy"></i>
                        </button>
                        <button class="table-btn btn-delete" onclick="deletePAC('${doc.id}')">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });

        document.getElementById("prevBtn").disabled = currentPage <= 1;
        document.getElementById("paginationControls").style.display = "block";
    });
}

function nextPage() {
    loadPACs(selectedUser.uclId, true);
}

function prevPage() {
    if (currentPage > 1) {
        loadPACs(selectedUser.uclId, false);
    }
}

/* ---------------- ACTION BUTTONS ---------------- */
function copyPAC(id){
  navigator.clipboard.writeText(id);
  alert("PAC Copied: " + id);
}

function deletePAC(id){
  if(!confirm("Delete this PAC?")) return;
  db.collection("pac_entries").doc(id).delete().then(()=>{
    alert("PAC Deleted.");
    resetPagination();
    loadPACs(selectedUser.uclId, true);
  });
}

/* ---------------- NAV MENU LIVE ---------------- */
function loadNavMenuLive(){
  const menu = document.getElementById("mainMenu");
  const current = window.location.pathname;

  db.collection("pacnav").orderBy("order").onSnapshot(snap=>{
    let html = "";
    snap.forEach(doc=>{
      const v = doc.data();
      if(v.url !== current){
        html += `<a href="${v.url}"><i class="${v.icon}"></i> ${v.title}</a>`;
      }
    });
    menu.innerHTML = html;
  });
}
loadNavMenuLive();

/* MOBILE MENU */
function toggleMenu(){
  document.getElementById("mainMenu").classList.toggle("show");
}

getIP();
</script>

</body>
</html>
