<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PAC Management Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* üåà Global Styling */
    body {
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #e3f2fd, #f8f9fa);
      margin: 0;
      padding: 0;
      color: #333;
    }

header {
      background: #007bff;
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    header h1 { margin: 0; font-size: 24px; }
    nav a {
      color: white;
      text-decoration: none;
      margin-left: 20px;
      font-weight: bold;
    }
    nav a:hover { text-decoration: underline; }

    /* üí† Dashboard Summary */
    .status-bar {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
      margin: 20px auto;

    }

    .status-bar span {
      background: white;
      padding: 12px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.2s ease;
    }

    .status-bar span:hover {
      transform: translateY(-2px);
    }

    .live-count { border-left: 6px solid #28a745; }
    .copied-count { border-left: 6px solid #ffc107; }
    .sync-status { border-left: 6px solid #17a2b8; }
    .today-count { border-left: 6px solid #6f42c1; } /* Purple color badge for today‚Äôs count */
    .income-total{border-left: 6px solid #00c853; /* green */}
.income-total i {
  color: #00c853;
}

    /* DB Size ‚Äì Blue-Green */
.db-size {
  border-left: 6px solid #198754; /* green */
}

/* Unused PACs ‚Äì Blue-Grey */
.unused-count {
  border-left: 6px solid #6c757d; /* grey */
}/* Usage Percentage ‚Äì Sky Blue */
.percent-used {
  border-left: 6px solid #0dcaf0; /* cyan */
}

        /* üîÑ Sync Icon Rotate Animation */
@keyframes syncSpin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.sync-status i {
  display: inline-block;
  animation: syncSpin 2s linear infinite;
}

/* üåü Smooth Glow Pulse for the whole Sync Box */
@keyframes syncGlow {
  0% { box-shadow: 0 0 6px rgba(23,162,184,0.3); }
  50% { box-shadow: 0 0 14px rgba(23,162,184,0.7); }
  100% { box-shadow: 0 0 6px rgba(23,162,184,0.3); }
}

.sync-status {
  animation: syncGlow 2.4s ease-in-out infinite;
}


    /* üîç Filter Box */
    .filter-bar {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(8px);
      padding: 15px;
      border-radius: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      max-width: 900px;
      margin: 0 auto 20px;
    }

    .filter-bar input, .filter-bar select {
      padding: 10px 14px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 15px;
      outline: none;
      transition: all 0.3s ease;
    }

    .filter-bar input:focus, .filter-bar select:focus {
      border-color: #007bff;
      box-shadow: 0 0 8px rgba(0,123,255,0.3);
    }

    .filter-bar button {
      background: linear-gradient(90deg, #007bff, #0056b3);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      font-weight: bold;
    }

    .filter-bar button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    /* üåü Beautiful Modern Table with Borders */
.table-container {
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

/* üåà Cute Blue Cloud Table */
table {
  width: 95%;
  margin: 20px auto 40px;
  border-collapse: collapse;
  background: linear-gradient(135deg, #e0f7ff, #ffffff, #e0f7ff);
  background-size: 300% 300%;
  animation: bgFlow 10s ease infinite;
  border: 1px solid #b3d8ff;
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 6px 20px rgba(0, 123, 255, 0.1);
  transition: all 0.3s ease-in-out;
}

/* üí´ Subtle animated gradient background */
@keyframes bgFlow {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}


/* üåà Animated Table Header */
thead {
  background: linear-gradient(270deg, #007bff, #00b4d8, #00c6ff, #007bff);
  background-size: 400% 400%;
  color: #fff;
  text-transform: uppercase;
  letter-spacing: 0.7px;
  animation: headerFlow 8s ease infinite;
  transition: all 0.3s ease;
  position: relative;
}

/* Header cells */
thead th {
  padding: 14px;
  font-size: 14px;
  font-weight: 600;
  border: 1px solid rgba(255, 255, 255, 0.3);
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

/* ‚ú® Smooth gradient movement */
@keyframes headerFlow {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}


/* Table Body */
tbody tr {
  transition: all 0.2s ease-in-out;
  border-bottom: 1px solid #e0e0e0;
}

tbody tr:nth-child(even) {
  background-color: #f8faff;
}

tbody tr:hover {
  background-color: #e3f2fd;
  transform: scale(1.005);
  box-shadow: 0 3px 8px rgba(0, 123, 255, 0.15);
}

td {
  padding: 12px;
  font-size: 15px;
  color: #333;
  border: 1px solid #d0d7de; /* inner grid lines */
}

/* Rounded corners for outermost cells */
th:first-child, td:first-child {
  border-left: 1px solid #d0d7de;
}

th:last-child, td:last-child {
  border-right: 1px solid #d0d7de;
}

tbody tr:last-child td {
  border-bottom: 1px solid #d0d7de;
}

/* Responsive Adjustments */
@media (max-width: 768px) {
  table {
    width: 100%;
    font-size: 13px;
  }
  th, td {
    padding: 10px;
  }
}


  /* üíé Elegant Animated 'Copied' Row Style */
.copied-row td {
  background: linear-gradient(270deg, #007bff, #00c6ff, #007bff);
  background-size: 400% 400%;
  color: #ffffff;
  font-weight: 600;
  letter-spacing: 0.4px;
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.25);
  border-color: rgba(0, 0, 0, 0.1);
  box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.15),
              0 0 12px rgba(0, 123, 255, 0.4);
  animation: gradientFlow 5s ease infinite, softPulse 3s ease-in-out infinite;
  transition: all 0.3s ease;
}

/* üåà Smooth flowing gradient animation */
@keyframes gradientFlow {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* ‚ú® Subtle glow pulse for a ‚Äúlive‚Äù effect */
@keyframes softPulse {
  0% { box-shadow: 0 0 10px rgba(0,123,255,0.3), inset 0 0 10px rgba(255,255,255,0.1); }
  50% { box-shadow: 0 0 20px rgba(0,123,255,0.6), inset 0 0 12px rgba(255,255,255,0.2); }
  100% { box-shadow: 0 0 10px rgba(0,123,255,0.3), inset 0 0 10px rgba(255,255,255,0.1); }
}


    /* üé® Buttons */
    .copy-btn { background: #007bff; color: white; }
    .notused-btn { background: #ffc107; color: black; }
    .delete-btn { background: #dc3545; color: white; }
    


    button {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
    }

    button:hover {
      transform: scale(1.05);
      opacity: 0.9;
    }

    .status-bar span:hover {
  box-shadow: 0 4px 10px rgba(0,123,255,0.2);
  transform: translateY(-2px);
}


    /* üîî Toast */
    #toast {
      visibility: hidden;
      opacity: 0;
      min-width: 250px;
      background: #007bff;
      color: #fff;
      text-align: center;
      border-radius: 10px;
      padding: 15px;
      position: fixed;
      z-index: 9999;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      font-size: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      transition: opacity 0.4s ease, visibility 0.4s ease;
    }

    #toast.show {
      visibility: visible;
      opacity: 1;
      animation: fadein 0.5s, fadeout 0.5s 2.5s;
    }

    @keyframes fadein {
      from { bottom: 0; opacity: 0; }
      to { bottom: 30px; opacity: 1; }
    }

    @keyframes fadeout {
      from { bottom: 30px; opacity: 1; }
      to { bottom: 0; opacity: 0; }
    }

    /* üì± Responsive */
    @media (max-width: 700px) {
      th, td { font-size: 13px; padding: 8px; }
      .filter-bar { flex-direction: column; }
      .status-bar { flex-direction: column; }
    }
#backupStatusBox {
  border-left: 6px solid #ff5722;
  animation: syncGlow 2s infinite;
}

/* üåà Backup box progress bar INSIDE status-box */
#backupStatusBox {
  position: relative;
  padding-right: 15px;
}

/* üåü Modern Pagination Styling */
.pagination-container {
  text-align: center;
  margin: 25px 0;
  display: flex;
  justify-content: center;
  gap: 10px;
  flex-wrap: wrap;
}

.pagination-btn {
  background: linear-gradient(135deg, #007bff, #0056b3);
  color: white;
  border: none;
  padding: 10px 18px;
  border-radius: 8px;
  font-size: 15px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.25s ease;
  box-shadow: 0 4px 8px rgba(0, 123, 255, 0.25);
}

.pagination-btn:hover:not(.disabled) {
  transform: translateY(-3px);
  box-shadow: 0 6px 14px rgba(0, 123, 255, 0.35);
}

.pagination-btn.disabled {
  background: #bcd4f7;
  color: #666;
  cursor: not-allowed;
  box-shadow: none;
}

.page-info-box {
  background: white;
  border: 2px solid #007bff;
  padding: 8px 18px;
  border-radius: 10px;
  font-weight: bold;
  font-size: 15px;
  color: #007bff;
  box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2);
}

  </style>
</head>

<body>

<header>
  <h1><i class="fa-solid fa-database"></i> PAC Management System</h1>
  <nav>
    <a href="/index.html"><i class="fa-solid fa-house"></i> Home</a>
    <a href="/pastenewadd.html"><i class="fa-solid fa-plus-circle"></i> Add PAC</a>
    <a href="/usedpac.html"><i class="fa-solid fa-archive"></i> Used PACs</a>
    <a href="/contact"><i class="fa-solid fa-envelope"></i> Contact</a>
  </nav>
</header>

<!-- üî¢ Dashboard Counters -->
<div class="status-bar">
  <span class="live-count"><i class="fa-solid fa-database"></i> Live PACs: <strong id="totalCount">0</strong></span>
  <span class="copied-count"><i class="fa-solid fa-copy"></i> Total Copied: <strong id="copiedCount">0</strong></span>
  <span class="today-count"><i class="fa-solid fa-calendar-day"></i> Today Copied: <strong id="todayCopiedCount">0</strong></span>
  <span class="sync-status"><i class="fa-solid fa-sync-alt"></i> <span id="syncStatus">Synced</span></span>
  <span class="unused-count"><i class="fa-solid fa-box-open"></i> Unused PACs: <strong id="unusedCount">0</strong></span>
  <!---<span class="percent-used"><i class="fa-solid fa-chart-pie"></i> Usage: <strong id="pacPercent">0%</strong></span>-->
  <span class="db-size"><i class="fa-solid fa-database"></i> DB Size:<strong id="dbSize">--</strong></span>
  <span class="income-total"><i class="fa-solid fa-money-bill-wave"></i> Income (Unused): ‚Çπ<strong id="incomeTotal">0</strong></span>
 <span class="backup-status" id="backupStatusBox">
  <i class="fa-solid fa-cloud-arrow-up"></i>
  Backup: <strong id="backupPercent">0%</strong>

  <div id="lastBackup" style="font-size:12px;color:#555;margin-top:3px;">
    Last Backup: --
  </div>
</span>





</div>


<!-- üîç Filters -->
<div class="filter-bar">
  <input type="text" id="searchBox" placeholder="üîç Search PAC / UCL / IP" oninput="filterTable()">
  <input type="date" id="filterDate" onchange="filterTable()">
  <select id="filterStatus" onchange="filterTable()">
    <option value="">All Status</option>
    <option value="copied">Copied</option>
    <option value="unused">Not Used</option>
  </select>
  <button onclick="exportCSV()"><i class="fa-solid fa-file-export"></i> Export CSV</button>
</div>

<!-- üìã PAC Data Table -->
<table id="pacTable">
  <thead>
   <tr>
    <th onclick="sortTable(0)">UCL No</th>
    <th onclick="sortTable(1)">CSC Ref</th>
    <th onclick="sortTable(2)">PAC Code</th>
    <th onclick="sortTable(3)">Pac Order Date</th>
    <th onclick="sortTable(4)">Amount</th>
    <th onclick="sortTable(5)">Entry Date</th>
    <th onclick="sortTable(6)">Entry IP</th>
    <th onclick="sortTable(7)">Copy Date</th>
    <th onclick="sortTable(8)">Copy Time</th>
    <th onclick="sortTable(9)">IP Address</th>
    <th>Action</th>
  </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>
<div class="pagination-container">
  <button class="pagination-btn" id="prevBtn" onclick="prevPage()">‚üµ Prev</button>
  
  <span class="page-info-box" id="pageInfo">Page 1 of 1</span>
  
  <button class="pagination-btn" id="nextBtn" onclick="nextPage()">Next ‚ü∂</button>
</div>


<!-- üîî Toast -->
<div id="toast"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<!-- üìú Script Logic -->
<script>
// ---------------------- FIREBASE CONFIG ----------------------
const firebaseConfig = {
  apiKey: "AIzaSyCE2_x5xvW3wCsOx6jo9-ZhNOhgWm86cPY",
  authDomain: "mrsamrat08.firebaseapp.com",
  projectId: "mrsamrat08",
  storageBucket: "mrsamrat08.firebasestorage.app",
  messagingSenderId: "525481767881",
  appId: "1:525481767881:web:6fd53162b242709890ae18"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ---------------- SECOND BACKUP FIREBASE APP (Live Sync) ----------------
const liveBackupConfig = {
  apiKey: "AIzaSyAW-D-FVxt8UwoZaDGs4QTcbV4mmFkcNzY",
  authDomain: "live-chat-2fd58.firebaseapp.com",
  projectId: "live-chat-2fd58",
  storageBucket: "live-chat-2fd58.firebasestorage.app",
  messagingSenderId: "510975811904",
  appId: "1:510975811904:web:e553dfe2f3efa7772f9aa5",
  measurementId: "G-NE1J2NSTT9"
};

// Create second instance
const liveBackupApp = firebase.initializeApp(liveBackupConfig, "liveBackupApp");
const liveBackupDB = liveBackupApp.firestore();


// Global
let allEntries = [];
let lastCopiedId = localStorage.getItem("lastCopiedId") || null;
let todayCount = 0;
let copyLock = false;
let smoothBackupValue = 0;
let backupAnimRunning = false;
let currentPage = 1;
let rowsPerPage = 10;   // You can change to 50, 100 etc.
let filteredTableData = [];


// ---------------------- REAL-TIME LISTENER FOR PAC ----------------------
db.collection("pac_entries").onSnapshot(snapshot => {
  allEntries = [];
  snapshot.forEach(doc => allEntries.push({ id: doc.id, ...doc.data() }));

  updateCounters();
  filterTable();
  calculateDBSize();
  document.getElementById("syncStatus").innerText = "Synced";
});


function getLocalISTDate() {
  const d = new Date();
  const year = d.getFullYear();
  const month = ("0" + (d.getMonth() + 1)).slice(-2);
  const day = ("0" + d.getDate()).slice(-2);
  return `${year}-${month}-${day}`;
}


// ---------------------- TODAY USED COUNT ----------------------
db.collection("today_used_pac").onSnapshot(snapshot => {

  const todayDate = getLocalISTDate(); // üî• correct IST date

  todayCount = 0;

  snapshot.forEach(doc => {
    const data = doc.data();

    if (data.copyDate === todayDate) {
      todayCount++;
    }
  });

  document.getElementById("todayCopiedCount").innerText = todayCount;
});


// ---------------------- TOAST ----------------------
function showToast(msg, color = "#007bff") {
  const toast = document.getElementById("toast");
  toast.textContent = msg;
  toast.style.background = color;
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 2500);
}

// ---------------------- FINAL MERGED updateCounters() ----------------------
function updateCounters() {
  const total = allEntries.length;
  const copied = allEntries.filter(e => Boolean(e.copied)).length;
  const unused = total - copied;
  const percent = total ? Math.round((copied / total) * 100) : 0;

  document.getElementById("totalCount").innerText = total;
  document.getElementById("copiedCount").innerText = copied;
  document.getElementById("unusedCount").innerText = unused;
  //document.getElementById("pacPercent").innerText = percent + "%";

  // üî• NEW ‚Üí Income Total for UNUSED PACs
  let income = 0;
  allEntries.forEach(e => {
    if (!e.copied) {
      let amt = parseFloat(e.amount);
      if (!isNaN(amt)) income += amt;
    }
  });
  document.getElementById("incomeTotal").innerText = income.toLocaleString("en-IN");

  const todayEl = document.getElementById("todayCopiedCount").parentElement;
  todayEl.style.borderLeft = todayCount > 0 ? "6px solid #6f42c1" : "6px solid #ccc";
}


// ---------------------- FILTER TABLE ----------------------
function filterTable() {
  const search = document.getElementById("searchBox").value.trim().toLowerCase();
  const date = document.getElementById("filterDate").value;
  const status = document.getElementById("filterStatus").value;

  // Filter PACs
  filteredTableData = allEntries.filter(e => {
    const id = (e.id || "").toLowerCase();
    const uclNo = (e.uclNo || "").toLowerCase();
    const copyIP = (e.copyIP || "").toLowerCase();
    const entryDate = e.entryDate || "";

    const matchSearch = !search ||
      id.includes(search) || uclNo.includes(search) || copyIP.includes(search);

    const matchDate = !date || entryDate === date;

    const matchStatus =
      status === "copied" ? Boolean(e.copied) :
      status === "unused" ? !e.copied : true;

    return matchSearch && matchDate && matchStatus;
  });

  currentPage = 1;   // reset to first page  
  renderTablePage();
  updatePaginationControls();
}

function renderTablePage() {
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";

  if (filteredTableData.length === 0) {
    tbody.innerHTML = "<tr><td colspan='11'>No PACs found.</td></tr>";
    return;
  }

  const start = (currentPage - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const pageData = filteredTableData.slice(start, end);

  pageData.forEach(e => {
    const tr = document.createElement("tr");
    if (e.copied) tr.classList.add("copied-row");

    let buttons = "";
    if (e.copied) {
      buttons = `
        <button class="notused-btn" onclick="resetCopy('${e.id}')"><i class="fa-solid fa-undo"></i></button>
        <button class="delete-btn" onclick="deletePAC('${e.id}')"><i class="fa-solid fa-trash"></i></button>`;
    } else {
      buttons = `
        <button class="copy-btn" onclick="copyCode('${e.id}')"><i class="fa-solid fa-copy"></i></button>
        <button class="delete-btn" onclick="deletePAC('${e.id}')"><i class="fa-solid fa-trash"></i></button>`;
    }

    tr.innerHTML = `
      <td>${e.uclNo || ""}</td>
      <td>${e.cscRef || ""}</td>
      <td>${e.id || ""}</td>
      <td>${e.orderDate || ""}</td>
      <td>${e.amount || ""}</td>
      <td>${e.entryDate || ""}</td>
      <td>${e.ipAddress || ""}</td>
      <td>${e.copyDate || "-"}</td>
      <td>${e.copyTime || "-"}</td>
      <td>${e.copyIP || "-"}</td>
      <td>${buttons}</td>`;

    tbody.appendChild(tr);
  });
}



function updatePaginationControls() {
  const totalPages = Math.ceil(filteredTableData.length / rowsPerPage);

  document.getElementById("pageInfo").innerText =
    `Page ${currentPage} of ${totalPages}`;

  document.getElementById("prevBtn").disabled = currentPage === 1;
  document.getElementById("nextBtn").disabled = currentPage === totalPages;
}

function nextPage() {
  const totalPages = Math.ceil(filteredTableData.length / rowsPerPage);

  if (currentPage < totalPages) {
    currentPage++;
    renderTablePage();
    updatePaginationControls();
  }
}

function prevPage() {
  if (currentPage > 1) {
    currentPage--;
    renderTablePage();
    updatePaginationControls();
  }
}

function getIST() {
  const d = new Date();

  // Correct IST Date (YYYY-MM-DD)
  const date =
    d.getFullYear() + "-" +
    ("0" + (d.getMonth() + 1)).slice(-2) + "-" +
    ("0" + d.getDate()).slice(-2);

  // Correct 12-hour time with AM/PM
  const time = d.toLocaleTimeString("en-IN", {
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hour12: true
  });

  return { date, time };
}

// ---------------------- COPY PAC ----------------------
async function copyCode(id) {

   // üîâ Play sound IMMEDIATELY on click (browser allows this)
  document.getElementById("copySound").currentTime = 0;
  document.getElementById("copySound").play().catch(()=>{});

  if (copyLock) {
    showToast("‚è≥ Please wait 2 seconds!", "#ff9800");
    return;
  }

  copyLock = true;
  setTimeout(() => copyLock = false, 2000);

  // Read current PAC
  const doc = await db.collection("pac_entries").doc(id).get();
  if (!doc.exists) return showToast("PAC not found!", "#dc3545");

  await navigator.clipboard.writeText(id);

  // ‚úÖ Get Correct IST Date & Time (NO +5.5 hours)
  const { date, time } = getIST();

  // Get IP
  const ip = await fetch("https://api.ipify.org?format=json")
    .then(r => r.json())
    .then(r => r.ip);

  // üî• ALWAYS MOVE PREVIOUS PAC AFTER NEW COPY
  if (lastCopiedId && lastCopiedId !== id) {
    const prev = await db.collection("pac_entries").doc(lastCopiedId).get();

    if (prev.exists) {
      const prevData = prev.data();

      // Move old PAC to used_pac
      await db.collection("used_pac").doc(lastCopiedId).set(prevData);

      // Delete from pac_entries
      await db.collection("pac_entries").doc(lastCopiedId).delete();
    }
  }

  // Update current PAC
  await db.collection("pac_entries").doc(id).update({
    copied: true,
    copyDate: date,   // ‚úÖ Correct IST date
    copyTime: time,   // ‚úÖ Correct 12-hour IST time
    copyIP: ip
  });

  // Add today record
  await db.collection("today_used_pac").add({
    pacId: id,
    copyDate: date,
    copyTime: time,
    copyIP: ip
  });

  lastCopiedId = id;
  localStorage.setItem("lastCopiedId", id);
document.getElementById("copySound").play();

  showToast("‚úÖ PAC Copied!", "#28a745");
}



// ---------------------- RESET PAC ----------------------
async function resetCopy(id) {
  try {
    await db.collection("pac_entries").doc(id).update({
      copied: false,
      copyDate: "",
      copyTime: "",
      copyIP: ""
    });

    if (lastCopiedId === id) {
      lastCopiedId = null;
      localStorage.removeItem("lastCopiedId");
    }

    const now = new Date();
    const istNow = new Date(now.getTime() + 5.5 * 3600 * 1000);
    const todayDate = istNow.toISOString().split("T")[0];

    const snapshot = await db.collection("today_used_pac")
      .where("pacId", "==", id)
      .where("copyDate", "==", todayDate)
      .get();

    const batch = db.batch();
    snapshot.forEach(d => batch.delete(d.ref));
    await batch.commit();

    showToast("‚ôªÔ∏è PAC Reset!", "#17a2b8");
  } catch (err) {
    showToast("Error resetting!", "#dc3545");
  }
}

// ---------------------- DELETE ----------------------
async function deletePAC(id) {
  // Ask with PAC code included
  if (!confirm(`Delete PAC ${id} permanently?`)) return;

  // Delete from database
  await db.collection("pac_entries").doc(id).delete();

  // Toast with PAC code included
  showToast(`üóëÔ∏è PAC ${id} Deleted!`, "#dc3545");
}


// ---------------------- CSV EXPORT ----------------------
function exportCSV() {
  if (!allEntries.length) return showToast("No Data!", "#ffc107");

  // Generate date + time in your format: DD-YY-MM MM-HH-SS
  const now = new Date();

  const dd = String(now.getDate()).padStart(2, "0");
  const yy = String(now.getFullYear()).slice(2);
  const mm = String(now.getMonth() + 1).padStart(2, "0");

  const HH = String(now.getHours()).padStart(2, "0");
  const MM = String(now.getMinutes()).padStart(2, "0");
  const SS = String(now.getSeconds()).padStart(2, "0");

  const fileName = `PAC ${dd}-${yy}-${mm} ${MM}-${HH}-${SS}.csv`;

  // Extract all unique keys
  const keys = Array.from(
    new Set(allEntries.flatMap(entry => Object.keys(entry)))
  );

  const headers = keys.join(",");

  const rows = allEntries.map(entry =>
    keys.map(key => (entry[key] !== undefined ? `"${entry[key]}"` : "")).join(",")
  );

  const csv = [headers, ...rows].join("\n");

  const blob = new Blob([csv], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = fileName;
  link.click();

  showToast("üìÅ Full CSV Exported!", "#17a2b8");
}

// ---------------------- DB SIZE CALCULATOR ----------------------
function getFirestoreFieldSize(value) {
    if (value === null || value === undefined) return 1;

    switch (typeof value) {
        case "string":
            return value.length + 1;  // UTF-8 length + 1 byte
        case "number":
            return 8;                // Firestore always uses 8 bytes
        case "boolean":
            return 1;
        case "object":
            if (value instanceof Array) {
                let arrSize = 1; // array metadata
                value.forEach(v => arrSize += getFirestoreFieldSize(v));
                return arrSize;
            } else if (value instanceof Date) {
                return 8; // Firestore stores timestamp as 64-bit
            } else {
                // nested document
                let objSize = 0;
                for (let key in value) {
                    objSize += key.length + 1;        // field name + metadata
                    objSize += getFirestoreFieldSize(value[key]);
                }
                return objSize;
            }
        default:
            return 0;
    }
}

function getUTF8Size(str) {
  let size = 0;
  for (let i = 0; i < str.length; i++) {
    const code = str.charCodeAt(i);
    if (code <= 0x7f) size += 1;
    else if (code <= 0x7ff) size += 2;
    else if (code <= 0xffff) size += 3;
    else size += 4;
  }
  return size;
}

function calculateFieldSize(value) {
  if (value === null || value === undefined) return 1; // null = 1 byte

  if (typeof value === "string") {
    return getUTF8Size(value) + 1; // +1 byte metadata
  }

  if (typeof value === "number") return 8; // Firestore always 8 bytes (double)
  if (typeof value === "boolean") return 1;

  if (value instanceof Date) return 16; // timestamp = 16 bytes

  if (Array.isArray(value)) {
    let size = 1; // array type metadata
    value.forEach(v => size += calculateFieldSize(v));
    return size;
  }

  if (typeof value === "object") {
    let size = 1; // object metadata
    for (let key in value) {
      size += getUTF8Size(key) + 1;   // field name + metadata
      size += calculateFieldSize(value[key]);
    }
    return size;
  }

  return 0;
}

function calculateDBSize() {
  let totalBytes = 0;

  allEntries.forEach(doc => {
    let docSize = 32; // base Firestore document overhead (fixed)

    // add document ID size (UTF-8)
    docSize += getUTF8Size(doc.id);

    for (let key in doc) {
      docSize += getUTF8Size(key) + 1; // field name
      docSize += calculateFieldSize(doc[key]); // field value
      docSize += 32; // index entry cost (approx)
    }

    totalBytes += docSize;
  });

  let sizeText = "";
  if (totalBytes < 1024) sizeText = totalBytes + " B";
  else if (totalBytes < 1024 * 1024) sizeText = (totalBytes / 1024).toFixed(1) + " KB";
  else sizeText = (totalBytes / (1024 * 1024)).toFixed(2) + " MB";

  document.getElementById("dbSize").innerText = sizeText;
}


// ---------------------- COLUMN SORTING ----------------------
let sortDirection = {};
function sortTable(columnIndex) {
  const table = document.getElementById("pacTable");
  const tbody = table.querySelector("tbody");
  const rows = Array.from(tbody.querySelectorAll("tr"));

  // Toggle ascending/descending
  sortDirection[columnIndex] = !sortDirection[columnIndex];
  const isAsc = sortDirection[columnIndex];

  rows.sort((a, b) => {
    let aText = a.children[columnIndex].innerText.trim();
    let bText = b.children[columnIndex].innerText.trim();

    // convert numbers
    if (!isNaN(parseFloat(aText)) && !isNaN(parseFloat(bText))) {
      return isAsc ? aText - bText : bText - aText;
    }

    return isAsc ? aText.localeCompare(bText) : bText.localeCompare(aText);
  });

  // Re-attach sorted rows
  rows.forEach(row => tbody.appendChild(row));
}

// ---------------------- LIVE BACKUP SYSTEM ----------------------
// ---------------------- FIREBASE BACKUP SYSTEM (5 HOURS SAFE) ----------------------
let backupRunning = false;

// Collections to backup
const collectionsToBackup = ["pac_entries", "used_pac", "today_used_pac"];

/*
   FUNCTION 1:
   üî• Load last backup time from Firebase (only 1 read!)
*/
async function loadBackupTime() {
  try {
    const doc = await liveBackupDB.collection("backup_status")
      .doc("last_backup")
      .get();

    if (doc.exists) {
      const t = doc.data().lastBackupTime;
      document.getElementById("lastBackup").innerText =
        "Last Backup: " + new Date(t).toLocaleString("en-IN");

      return t;
    } else {
      document.getElementById("lastBackup").innerText =
        "Last Backup: No backup yet";
      return 0;
    }

  } catch (err) {
    console.error("Error loading backup time:", err);
    return 0;
  }
}


/*
   FUNCTION 2:
   üî• Animate Backup Progress
*/
function animateBackupTo(target) {
  const text = document.getElementById("backupPercent");
  target = Math.min(100, Math.max(0, target));

  const interval = setInterval(() => {
    if (smoothBackupValue < target) {
      smoothBackupValue++;
      text.innerText = smoothBackupValue + "%";
    } else {
      clearInterval(interval);
    }
  }, 15);
}


/*
   FUNCTION 3:
   üî• Start Backup (ONLY IF 5 HOURS PASSED)
*/
async function startBackupProcess() {
  if (backupRunning) return;

  backupRunning = true;

  const lastTime = await loadBackupTime(); // Fetch from Firebase
  const now = Date.now();
  const hoursPassed = (now - lastTime) / (1000 * 60 * 60);

  // ‚ùå If backup done < 5 hours ago ‚Üí DO NOT BACKUP
  if (hoursPassed < 5) {
    console.log("‚õî Backup skipped. Not 5 hours yet.");
    document.getElementById("backupPercent").innerText = "100%";
    backupRunning = false;
    return;
  }

  console.log("üî• Starting new backup...");
  smoothBackupValue = 0;
  document.getElementById("backupPercent").innerText = "0%";

  try {
    let totalDocs = 0;
    let backedDocs = 0;

    // Count total documents
    for (const col of collectionsToBackup) {
      const snap = await db.collection(col).get();
      totalDocs += snap.size;
    }

    if (totalDocs === 0) {
      animateBackupTo(100);
      await saveBackupTimeToFirebase();
      backupRunning = false;
      return;
    }

    // Backup each collection
    for (const col of collectionsToBackup) {
      const snap = await db.collection(col).get();
      const batch = liveBackupDB.batch();

      snap.docs.forEach(doc => {
        batch.set(
          liveBackupDB.collection(col).doc(doc.id),
          doc.data()
        );
      });

      await batch.commit();

      backedDocs += snap.size;
      animateBackupTo(Math.round((backedDocs / totalDocs) * 100));
    }

    // Save new backup time
    await saveBackupTimeToFirebase();

    document.getElementById("backupStatusBox").style.borderLeft =
      "6px solid #28a745";

  } catch (error) {
    console.error("Backup Error:", error);
    document.getElementById("backupPercent").innerText = "ERROR";
  }

  backupRunning = false;
}


/*
   FUNCTION 4:
   üî• Save backup time to Firebase
*/
async function saveBackupTimeToFirebase() {
  const timeNow = Date.now();

  await liveBackupDB.collection("backup_status")
    .doc("last_backup")
    .set({
      lastBackupTime: timeNow
    });

  document.getElementById("lastBackup").innerText =
    "Last Backup: " + new Date(timeNow).toLocaleString("en-IN");
}


/*
   RUN BACKUP:
   üî• Check automatically every 5 hours
*/
setInterval(startBackupProcess, 5 * 60 * 60 * 1000);

// üî• Run ONCE on page load
startBackupProcess();




</script>
  <audio id="copySound">
  <source src="https://assets.mixkit.co/sfx/preview/mixkit-interface-click-1126.mp3" type="audio/mpeg">
</audio>
</body>
</html>
